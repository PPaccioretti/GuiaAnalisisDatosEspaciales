<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="es" xml:lang="es"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.313">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="<p>“Mariano Córdoba, Pablo Paccioretti, Franca Giannini Kurina, Cecilia Bruno, Mónica Balzarini”</p>">
<meta name="description" content="DISEMINACIÓN CIENTÍFICA Y TRASNFERENCIA DE RESULTADOS DE INVESTIGACIÓN, PROMOVIDAS POR EL MINISTERIO DE CIENCIA Y TECNOLOGÍA DE LA PROVINCIA DE CÓRDOBA.">
<title>Guía para el análisis de datos espaciales. Aplicaciones en agricultura - 7&nbsp; Bases de datos regionales</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./referencias.html" rel="next">
<link href="./Parte2_cap_b_EscFinaImplInfo.html" rel="prev">
<link href="./figuras/cover.jpg" rel="icon" type="image/jpeg">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "Sin resultados",
    "search-matching-documents-text": "documentos encontrados",
    "search-copy-link-title": "Copiar el enlace en la búsqueda",
    "search-hide-matches-text": "Ocultar resultados adicionales",
    "search-more-match-text": "resultado adicional en este documento",
    "search-more-matches-text": "resultados adicionales en este documento",
    "search-clear-button-title": "Borrar",
    "search-detached-cancel-button-title": "Cancelar",
    "search-submit-button-title": "Enviar"
  }
}</script><style>html{ scroll-behavior: smooth; }</style>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-154490537-1', 'auto');
  ga('send', 'pageview');

</script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }"><div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">
<span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Bases de datos regionales</span>
</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Guía para el análisis de datos espaciales. Aplicaciones en agricultura</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/PPaccioretti/GuiaAnalisisDatosEspaciales" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
    <a href="./GuiaAnalisisDatosEspaciales.pdf" title="Download PDF" class="sidebar-tool px-1"><i class="bi bi-file-pdf"></i></a>
  <a href="" class="quarto-reader-toggle sidebar-tool" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Prólogo</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Aproximaciones metodológicas</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Parte1_cap_a_MjoDtosEsp.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Manejo de datos espaciales</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Parte1_cap_b_CarcVarEsp.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Caracterización de variabilidad espacial</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Parte1_cap_c_CarcVarEspMultiCapa.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Caracterización de variabilidad espacial con múltiples capas de datos</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Parte1_cap_d_PredMultipleCapa.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Predicción con múltiples capas de datos</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">Análisis de datos a escala fina</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Parte2_cap_a_EscFinaImplR.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Implementación con R</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Parte2_cap_b_EscFinaImplInfo.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Implementación con InfoStat</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">Análisis de datos a escala regional</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Parte3_cap_a_EscRegionImplR.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Bases de datos regionales</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./referencias.html" class="sidebar-item-text sidebar-link">Referencias</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">Apéndices</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./anexoR.html" class="sidebar-item-text sidebar-link">Introducción a R</a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><!-- margin-sidebar --><div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Tabla de contenidos</h2>
   
  <ul>
<li><a href="#manejo-de-datos-espaciales" id="toc-manejo-de-datos-espaciales" class="nav-link active" data-scroll-target="#manejo-de-datos-espaciales"><span class="toc-section-number">7.1</span>  Manejo de datos espaciales</a></li>
  <li><a href="#confecci%C3%B3n-de-grillas-de-predicci%C3%B3n" id="toc-confección-de-grillas-de-predicción" class="nav-link" data-scroll-target="#confecci%C3%B3n-de-grillas-de-predicci%C3%B3n"><span class="toc-section-number">7.2</span>  Confección de grillas de predicción</a></li>
  <li><a href="#agregado-de-capas-de-informaci%C3%B3n" id="toc-agregado-de-capas-de-información" class="nav-link" data-scroll-target="#agregado-de-capas-de-informaci%C3%B3n"><span class="toc-section-number">7.3</span>  Agregado de capas de información</a></li>
  <li>
<a href="#predicci%C3%B3n-con-m%C3%BAltiples-capas-de-datos" id="toc-predicción-con-múltiples-capas-de-datos" class="nav-link" data-scroll-target="#predicci%C3%B3n-con-m%C3%BAltiples-capas-de-datos"><span class="toc-section-number">8</span>  Predicción con múltiples capas de datos</a>
  <ul class="collapse">
<li><a href="#regresi%C3%B3n-con-errores-correlacionados-espacialmente-v%C3%ADa-reml" id="toc-regresión-con-errores-correlacionados-espacialmente-vía-reml" class="nav-link" data-scroll-target="#regresi%C3%B3n-con-errores-correlacionados-espacialmente-v%C3%ADa-reml"><span class="toc-section-number">8.1</span>  Regresión con errores correlacionados espacialmente vía REML</a></li>
  <li>
<a href="#regresi%C3%B3n-con-efectos-aleatorios-de-sitio-v%C3%ADa-inla" id="toc-regresión-con-efectos-aleatorios-de-sitio-vía-inla" class="nav-link" data-scroll-target="#regresi%C3%B3n-con-efectos-aleatorios-de-sitio-v%C3%ADa-inla"><span class="toc-section-number">8.2</span>  Regresión con efectos aleatorios de sitio vía INLA</a>
  <ul class="collapse">
<li><a href="#obtenci%C3%B3n-de-predicciones" id="toc-obtención-de-predicciones" class="nav-link" data-scroll-target="#obtenci%C3%B3n-de-predicciones"><span class="toc-section-number">8.2.1</span>  Obtención de predicciones</a></li>
  </ul>
</li>
  <li><a href="#predicciones-utilizando-el-paquete-inlabru" id="toc-predicciones-utilizando-el-paquete-inlabru" class="nav-link" data-scroll-target="#predicciones-utilizando-el-paquete-inlabru"><span class="toc-section-number">8.3</span>  Predicciones utilizando el paquete <code>inlabru</code></a></li>
  <li><a href="#utilizando-inla" id="toc-utilizando-inla" class="nav-link" data-scroll-target="#utilizando-inla"><span class="toc-section-number">8.4</span>  Utilizando <code>INLA</code></a></li>
  <li><a href="#regresi%C3%B3n-v%C3%ADa-modelos-basados-en-%C3%A1rbol" id="toc-regresión-vía-modelos-basados-en-árbol" class="nav-link" data-scroll-target="#regresi%C3%B3n-v%C3%ADa-modelos-basados-en-%C3%A1rbol"><span class="toc-section-number">8.5</span>  Regresión vía modelos basados en árbol</a></li>
  </ul>
</li>
  </ul><div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/PPaccioretti/GuiaAnalisisDatosEspaciales/edit/main/Parte3_cap_a_EscRegionImplR.qmd" class="toc-action">Editar esta página</a></p><p><a href="https://github.com/PPaccioretti/GuiaAnalisisDatosEspaciales/issues/new" class="toc-action">Informar de un problema</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title d-none d-lg-block">
<span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Bases de datos regionales</span>
</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Código</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><p>Muchos procesos aleatorios varían de manera continua en el espacio a escala regional. Entonces, es de interés predecir el comportamiento de una variable en referencia a su ubicación geográfica. En algunas situaciones además de la distribución en el espacio otras capas de información (covariables de sitio) pueden ser usadas para mejorar la predicción en un sitio específico. En esta parte se ilustran el manejo de datos espaciales para la predicción a escala regional de una variable a partir de múltiples capas de información y la construcción de un modelo de predicción espacial vía estrategias metodológicas alternativas: regresión múltiple vía REML, regresión múltiple vía INLA y regresión no lineal vía modelo basado en árbol.</p>
<p>Como ejemplo se utiliza la base de datos <strong>suelos_cba.txt</strong>. Esta es una parte del SIG de los suelos del horizonte superficial de la provincia Córdoba <span class="citation" data-cites="Hang2015">(<a href="referencias.html#ref-Hang2015" role="doc-biblioref">Hang et&nbsp;al. 2015</a>)</span>, que contiene 350 sitios caracterizados por múltiples variables edáficas que describen los primeros 15 cm de profundidad. Las variables presentes en <strong>suelos_cba.txt</strong> son: COS (Carbono Orgánico de Suelo, g/kg) arcilla (%), pH, elevación (m.s.n.m.), twi (Índice Topográfico de Humedad). El objetivo del análisis es ajustar modelos que expliquen la variabilidad espacial de COS en función de las restantes variables en la base de datos.</p>
<p>Para seguir la ilustración, cargar los paquetes específicos de R que albergan las funciones que se utilizarán tanto para el manejo como para la modelación.</p>
<div class="cell">

</div>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/terra/">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-tmap/tmap">tmap</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://svn.r-project.org/R-packages/trunk/nlme/">nlme</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">INLA</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.inlabru.org">inlabru</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/topepo/caret/">caret</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/gstat/">gstat</a></span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">

</div>
<section id="manejo-de-datos-espaciales" class="level2" data-number="7.1"><h2 data-number="7.1" class="anchored" data-anchor-id="manejo-de-datos-espaciales">
<span class="header-section-number">7.1</span> Manejo de datos espaciales</h2>
<p>Mediante la función <code><a href="https://rdrr.io/r/utils/read.table.html">read.table()</a></code> se lee un archivo de texto que se guarda como un objeto denominado <code>suelos</code>, en el cual las columnas están separadas por tabuladores y la primera fila contiene los nombres de columnas. Mediante la función <code><a href="https://rdrr.io/pkg/terra/man/headtail.html">head()</a></code> se visualizan las primeras filas del objeto <code>suelos</code> donde se observa que la primera columna corresponde a una identificación, las siguientes dos son las coordenadas X e Y las cuales corresponden al sistema de proyección UTM faja 20. Las columnas siguientes contienen las variables en estudio.</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">suelos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span><span class="op">(</span><span class="st">"datos/suelos_cba.txt"</span>,</span>
<span>                     sep <span class="op">=</span> <span class="st">"\t"</span>, header <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/headtail.html">head</a></span><span class="op">(</span><span class="va">suelos</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ID_2        X       Y elevacion twi arcilla  pH   COS
1    2 603163.6 6576899       100 135    30.8 6.6 25.98
2    3 596537.1 6390518        87 133    24.0 7.4 17.29
3    4 595665.5 6380484        93 126    28.5 6.1 17.43
4    5 601138.5 6353446       105 119    28.8 6.9 15.08
5    6 601798.1 6344096       111 127    25.2 7.4 17.30
6    7 587501.2 6615272        94 135    33.6 6.7 16.13</code></pre>
</div>
</div>
<p>Para transformar este objeto en uno de clase espacial, se utilizará la función <code><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf()</a></code>, especificando que las coordenadas X e Y, se encuentra en las columnas “X” e “Y”, respectivamente. Todos los sistemas de coordenadas tienen asociados un código que los identifica y que a través del cual, se pueden conocer los parámetros asociados al mismo, este código se llama EPSG por su acrónimo en inglés. El código EPSG del sistema de referencia y proyección de la base de datos es 32720. El objeto <code>suelos_sf</code>, ahora es un objeto espacial de clase <code>sf</code>, donde cada observación corresponde a cada sitio de muestreo. Se muestra el sistema de referencia y proyección de las coordenadas y el tipo de geometría.</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">suelos_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="va">suelos</span>, </span>
<span>                      coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span>, </span>
<span>                      crs <span class="op">=</span> <span class="fl">32720</span><span class="op">)</span></span>
<span><span class="va">suelos_sf</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 350 features and 6 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 235888.3 ymin: 6133188 xmax: 603163.6 ymax: 6722199
Projected CRS: WGS 84 / UTM zone 20S
First 10 features:
   ID_2 elevacion twi arcilla  pH   COS                 geometry
1     2       100 135    30.8 6.6 25.98 POINT (603163.6 6576899)
2     3        87 133    24.0 7.4 17.29 POINT (596537.1 6390518)
3     4        93 126    28.5 6.1 17.43 POINT (595665.5 6380484)
4     5       105 119    28.8 6.9 15.08 POINT (601138.5 6353446)
5     6       111 127    25.2 7.4 17.30 POINT (601798.1 6344096)
6     7        94 135    33.6 6.7 16.13 POINT (587501.2 6615272)
7     8        97 135    35.7 6.9 15.24 POINT (589808.2 6593001)
8     9       100 134    30.1 6.0 12.90 POINT (585406.5 6575712)
9    10       100 134    32.7 6.6 15.74 POINT (584319.9 6552571)
10   11       108 135    33.2 6.0 27.03 POINT (582795.8 6536823)</code></pre>
</div>
</div>
<p>Para explorar los datos se usa el paquete <code>tmap</code> que permite realizar gráficos estáticos o dinámicos. Con la opción dinámica, se puede interactuar con el gráfico de manera análoga a un SIG. Para cada gráfico, se comienza utilizando la función <code><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape()</a></code> especificando el objeto a graficar. Cada observación se grafica un punto mediante la función <code><a href="https://rdrr.io/pkg/tmap/man/tm_symbols.html">tm_dots()</a></code>, cada nivel se agrega mediante el símbolo <code>+</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">suelos_sf</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_symbols.html">tm_dots</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Parte3_cap_a_EscRegionImplR_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Para agregar latitud y longitud a esta figura se realiza una reproyección. En la función <code><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape()</a></code> se especifica el nuevo sistema de coordenadas con el que se desea graficar (argumento <code>projection</code>). Se agregar el nivel <code><a href="https://rdrr.io/pkg/tmap/man/tm_grid.html">tm_grid()</a></code> para visualizar una grilla que contiene las coordenadas latitud y longitud.</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">suelos_sf</span>, projection <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_grid.html">tm_grid</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"grey90"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_symbols.html">tm_dots</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Parte3_cap_a_EscRegionImplR_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Cualquiera de estos gráficos se puede convertir en un gráfico dinámico mediante la función <code><a href="https://rdrr.io/pkg/tmap/man/tmap_mode.html">tmap_mode()</a></code> especificando como argumento <code>"view"</code>. Para continuar con gráficos estáticos se debe especificar <code>"plot"</code> como argumento de esta función. Mediante la función <code><a href="https://rdrr.io/pkg/tmap/man/tm_tiles.html">tm_basemap()</a></code>, se pueden incorporar distintas capas base. Las opciones disponibles para las capas base se pueden ver mediante el comando <code>names(leaflet::providers)</code>.</p>
<p>Cualquiera de estos gráficos se puede convertir en un gráfico dinámico utilizando la función <code><a href="https://rdrr.io/pkg/tmap/man/tmap_mode.html">tmap_mode()</a></code> especificando como argumento <code>"view"</code>. Para continuar con gráficos estáticos se debe especificar <code>"plot"</code> como argumento de esta función. Mediante la función <code><a href="https://rdrr.io/pkg/tmap/man/tm_tiles.html">tm_basemap()</a></code>, se pueden incorporar distintas capas base (capas de fondo que ayudan a visualizar). Las opciones disponibles para las capas base se pueden ver mediante el comando <code>names(leaflet::providers)</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tmap_mode.html">tmap_mode</a></span><span class="op">(</span><span class="st">"view"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">suelos_sf</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_symbols.html">tm_dots</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_tiles.html">tm_basemap</a></span><span class="op">(</span><span class="st">"Esri.WorldImagery"</span>, <span class="st">"OpenTopoMap"</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<p><img src="figuras/suelossftmap.png" class="img-fluid" width="200"></p>
</div>
</div>
<div class="cell">

</div>
</section><section id="confección-de-grillas-de-predicción" class="level2" data-number="7.2"><h2 data-number="7.2" class="anchored" data-anchor-id="confección-de-grillas-de-predicción">
<span class="header-section-number">7.2</span> Confección de grillas de predicción</h2>
<p>Para generar esta grilla es necesario definir una resolución espacial en el área de interés. Para este ejemplo, se utiliza un archivo vectorial, <strong>limites_cba.shp</strong>, el cual define el límite del territorio sobre el que se desea predecir.</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">limites_cba</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">"datos/limites_cba.shp"</span>,</span>
<span>                       quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">limites_cba</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">limites_cba</span>, </span>
<span>                            crs <span class="op">=</span> <span class="fl">32720</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>La función <code><a href="https://r-spatial.github.io/sf/reference/st_make_grid.html">st_make_grid()</a></code> genera una grilla rectangular conteniendo el área del objeto <code>limites_cba</code>. Para definir la resolución espacial de la grilla se utiliza el argumento <code>cellsize</code> definiendo un tamaño de grilla en relación con la unidad de medida del sistema de coordenadas, en este caso 10000 metros, dado que está en UTM.</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">grilla_base</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_make_grid.html">st_make_grid</a></span><span class="op">(</span><span class="va">limites_cba</span>, </span>
<span>                            cellsize <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">grilla_base</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html">tm_borders</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">limites_cba</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html">tm_borders</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Parte3_cap_a_EscRegionImplR_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Dado que la grilla es rectangular, es necesario cortarla según los límites. Para esto se realiza una intersección entre los límites y la grilla utilizando la función <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">st_intersection()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">grilla_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">st_intersection</a></span><span class="op">(</span><span class="va">limites_cba</span>,</span>
<span>                               <span class="va">grilla_base</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">grilla_pred</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html">tm_borders</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Parte3_cap_a_EscRegionImplR_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Los algoritmos de predicción implementados trabajan prediciendo sitios puntuales, por lo cual, a partir de la grilla, es necesario generar una grilla de puntos. Una alternativa es utilizar la función <code><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_centroid()</a></code> para obtener el centroide de cada celda.</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">centroide_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_centroid</a></span><span class="op">(</span><span class="va">grilla_pred</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in st_centroid.sf(grilla_pred): st_centroid assumes attributes are
constant over geometries of x</code></pre>
</div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">centroide_pred</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_symbols.html">tm_dots</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Parte3_cap_a_EscRegionImplR_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section><section id="agregado-de-capas-de-información" class="level2" data-number="7.3"><h2 data-number="7.3" class="anchored" data-anchor-id="agregado-de-capas-de-información">
<span class="header-section-number">7.3</span> Agregado de capas de información</h2>
<p>Se presenta los comandos necesarios para combinar múltiples capas de información en un mismo objeto. Las variables elevación y twi son extraídas desde modelos digitales de elevación, que se encuentran en formato raster. El paquete <code>terra</code> de R es específico para lectura y manipulación de este tipo de archivos. Para leer un archivo de este formato, se puede utilizar la función <code><a href="https://rdrr.io/pkg/terra/man/rast.html">rast()</a></code> mientras que para reproyectar se utiliza la función <code><a href="https://rdrr.io/pkg/terra/man/project.html">project()</a></code>. El archivo <strong>elevacion.tif</strong> contiene datos de elevación para la provincia de Córdoba. Cuando se imprime el objeto, se muestra la cantidad de pixeles por fila, columna, pixeles totales, la resolución espacial, las coordenadas extremas en latitud y longitud, el sistema de coordenadas de referencia, los valores mínimo y máximo de la variable observada.</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">elevacion</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html">rast</a></span><span class="op">(</span><span class="st">"datos/elevacion.tif"</span><span class="op">)</span></span>
<span><span class="va">elevacion</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/terra/man/project.html">project</a></span><span class="op">(</span><span class="va">elevacion</span>, </span>
<span>          y <span class="op">=</span> <span class="st">"+proj=utm +zone=20 +south </span></span>
<span><span class="st">                +datum=WGS84 +units=m +no_defs"</span><span class="op">)</span></span>
<span><span class="va">elevacion</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class       : SpatRaster 
dimensions  : 3028, 2123, 1  (nrow, ncol, nlyr)
resolution  : 217.938, 217.938  (x, y)
extent      : 196380.6, 659063, 6100616, 6760532  (xmin, xmax, ymin, ymax)
coord. ref. : +proj=utm +zone=20 +south +datum=WGS84 +units=m +no_defs 
source(s)   : memory
name        :  elevacion 
min value   :   38.37358 
max value   : 2745.15332 </code></pre>
</div>
</div>
<p>Para obtener en los sitios de predicción el valor de la variable del objeto raster, se utiliza la función <code><a href="https://rdrr.io/pkg/terra/man/extract.html">extract()</a></code> definiendo como argumento el nombre del objeto raster y el nombre del objeto vectorial que contiene los sitios. Estos valores extraídos se adicionan en una columna llamada <code>elevacion</code> dentro del objeto <code>centroide_pred</code> utilizando la funcion <code>cbind</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">elevacion_val</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/terra/man/extract.html">extract</a></span><span class="op">(</span><span class="va">elevacion</span>, <span class="va">centroide_pred</span>, ID <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">centroide_pred</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">centroide_pred</span>,</span>
<span>        <span class="va">elevacion_val</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>El archivo <strong>twi.tif</strong> contiene valores de un índice topográfico de humedad también generado a partir de datos provenientes de un modelo digital de elevación..</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">twi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html">rast</a></span><span class="op">(</span><span class="st">"datos/twi.tif"</span><span class="op">)</span></span>
<span><span class="va">twi</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/terra/man/project.html">project</a></span><span class="op">(</span><span class="va">twi</span>, </span>
<span>         y <span class="op">=</span> <span class="st">"+proj=utm +zone=20 +south</span></span>
<span><span class="st">                +datum=WGS84 +units=m +no_defs"</span><span class="op">)</span></span>
<span><span class="va">twi</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class       : SpatRaster 
dimensions  : 1514, 1062, 1  (nrow, ncol, nlyr)
resolution  : 435.8761, 435.8761  (x, y)
extent      : 196380.6, 659280.9, 6100616, 6760532  (xmin, xmax, ymin, ymax)
coord. ref. : +proj=utm +zone=20 +south +datum=WGS84 +units=m +no_defs 
source(s)   : memory
name        :      twi 
min value   :  53.5437 
max value   : 137.8588 </code></pre>
</div>
</div>
<p>Utilizando la función <code><a href="https://rdrr.io/pkg/terra/man/extract.html">extract()</a></code> se extrae los valores de TWI para cada sitio de la grilla de predicción.</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">twi_val</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/extract.html">extract</a></span><span class="op">(</span><span class="va">twi</span>, <span class="va">centroide_pred</span>, ID <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">centroide_pred</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">centroide_pred</span>,</span>
<span>        <span class="va">twi_val</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Se adiciona a la grilla variables procedentes de otras fuentes (SIG de muestreo de suelo). Estos datos se encuentran en los archivos raster llamados <strong>arcilla.tif</strong> y <strong>pH.tif</strong>, respectivamente. Estos raster tienen la misma resolución espacial y extensión, por lo que es posible superponerlos en un mismo objeto mediante la función <code><a href="https://rdrr.io/r/base/c.html">c()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">arcilla</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html">rast</a></span><span class="op">(</span><span class="st">"datos/arcilla.tif"</span><span class="op">)</span></span>
<span><span class="va">pH</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html">rast</a></span><span class="op">(</span><span class="st">"datos/pH.tif"</span><span class="op">)</span></span>
<span><span class="va">edaf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">pH</span>, <span class="va">arcilla</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/crs.html">crs</a></span><span class="op">(</span><span class="va">edaf</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"+proj=utm +zone=20 +south +datum=WGS84 +units=m +no_defs"</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">edaf</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_raster.html">tm_raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_facets.html">tm_facets</a></span><span class="op">(</span>free.scales <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_layout.html">tm_legend</a></span><span class="op">(</span>position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'left'</span>,<span class="st">'bottom'</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Parte3_cap_a_EscRegionImplR_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Se seleccionan los valores de los sitios utilizando la función <code><a href="https://rdrr.io/pkg/terra/man/extract.html">extract()</a></code>. Como los valores extraídos mediante la funcion desde un <em>stack</em> de rasters genera un objeto de tipo <code>data.frame</code> con tantas columnas como capas contenga ese raster, se adicionan al objeto <code>centroide_pred</code> mediante la función <code><a href="https://rdrr.io/r/base/cbind.html">cbind()</a></code>, la cual une columnas de igual número de filas. Ahora el objeto <code>cetroide_pred</code> contiene todos los sitios de predicción con las variables auxiliares adicionadas.</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">edaf_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/extract.html">extract</a></span><span class="op">(</span><span class="va">edaf</span>, </span>
<span>                     <span class="va">centroide_pred</span>, </span>
<span>                     ID <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">centroide_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">centroide_pred</span>, </span>
<span>                        <span class="va">edaf_pred</span><span class="op">)</span></span>
<span><span class="va">centroide_pred</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 1668 features and 8 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 239427.6 ymin: 6129968 xmax: 614506.7 ymax: 6729403
Projected CRS: WGS 84 / UTM zone 20S
First 10 features:
          UNION JURISDICCI CAPITAL FUENTE elevacion      twi       pH   arcilla
1   -2147483648    CORDOBA CORDOBA    IGN  274.8449 118.4764 6.391590  8.209237
1.1 -2147483648    CORDOBA CORDOBA    IGN  257.2227 113.7088 6.262683  8.882079
1.2 -2147483648    CORDOBA CORDOBA    IGN  266.5454 112.7255 6.142890  9.475647
1.3 -2147483648    CORDOBA CORDOBA    IGN  255.0000 118.6159 6.136549  9.945969
1.4 -2147483648    CORDOBA CORDOBA    IGN  230.9800 119.1276 5.946674 10.268174
1.5 -2147483648    CORDOBA CORDOBA    IGN  201.1941 118.7030 5.782518 10.445782
1.6 -2147483648    CORDOBA CORDOBA    IGN  185.8633 123.6503 5.805237 10.512389
1.7 -2147483648    CORDOBA CORDOBA    IGN  176.7831 122.9565 5.846396 10.524518
1.8 -2147483648    CORDOBA CORDOBA    IGN  162.5928 126.4006 5.893137 10.547595
1.9 -2147483648    CORDOBA CORDOBA    IGN  156.4618 124.1537 5.920496 10.639622
                    geometry
1   POINT (310498.8 6129968)
1.1 POINT (319332.6 6130045)
1.2 POINT (329333.4 6130153)
1.3 POINT (339337.7 6130238)
1.4 POINT (349337.5 6130314)
1.5 POINT (359337.5 6130390)
1.6 POINT (369342.5 6130448)
1.7 POINT (379342.4 6130496)
1.8 POINT (389342.3 6130543)
1.9 POINT (399342.2 6130590)</code></pre>
</div>
</div>
<p>Para identificar la variación de la variable de interés en un plano, se puede usar una escala de colores. La elección de la escala cambia según los colores y los puntos de corte (valores de la variable de interés en los cuales cambia el color). Para definirla algunas opciones automáticamente identifican los valores para categorizar y asignar un color. Por defecto, <code>tmap</code> categoriza los valores en intervalos fijos. Utilizando el argumento <code>style</code>, se puede modificar el método a utilizar. Las opciones <code>style = "order"</code> y <code>style = "cont"</code> permiten representar variables numéricas en un gradiente de color. La opción “order” realiza una escala en función del ranking de los valores, permitiendo una mejor visualización de variables asimétricas. Para la visualización de más de un mapa generado con <code>tmap</code> en un mismo gráfico, se puede utilizar la función <code><a href="https://rdrr.io/pkg/tmap/man/tmap_arrange.html">tmap_arrange()</a></code>, utilizando como argumento los mapas que se quieren visualizar. El argumento <code>sync = TRUE</code> permite la visualización interactiva con la navegación (zoom y movimiento) sincronizada en ambos mapas.</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">elevTm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">centroide_pred</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_symbols.html">tm_dots</a></span><span class="op">(</span><span class="st">"elevacion"</span>, style <span class="op">=</span> <span class="st">"order"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">twiTm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">centroide_pred</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_symbols.html">tm_dots</a></span><span class="op">(</span><span class="st">"twi"</span>, style <span class="op">=</span> <span class="st">"cont"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pHTM</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">centroide_pred</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_symbols.html">tm_dots</a></span><span class="op">(</span><span class="st">"pH"</span>, style <span class="op">=</span> <span class="st">"cont"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">arcillaTm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">centroide_pred</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_symbols.html">tm_dots</a></span><span class="op">(</span><span class="st">"arcilla"</span>, style <span class="op">=</span> <span class="st">"cont"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tmap_arrange.html">tmap_arrange</a></span><span class="op">(</span><span class="va">elevTm</span>, <span class="va">twiTm</span>, <span class="va">pHTM</span>, <span class="va">arcillaTm</span>, </span>
<span>             ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Parte3_cap_a_EscRegionImplR_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section><section id="predicción-con-múltiples-capas-de-datos" class="level1" data-number="8"><h1 data-number="8">
<span class="header-section-number">8</span> Predicción con múltiples capas de datos</h1>
<p>Una vez que se ha confeccionado la grilla de predicción y se ha unificado el sistema de referencia espacial entre las distintas capas de información, se comienza con el ajuste de modelos que luego serán usados para la predicción espacial en sitios sin datos. El objeto <code>suelos</code>, se utilizará para el ajuste de los modelos predictivos, mientras que <code>cetroide_pred</code> se usará para obtener predicciones para cada celda de la grilla. La distribución espacial de la variable de interés (COS) puede visualizarse con funciones del paquete <code>tmap.</code> A través del argumento <code>palette</code> se modifica la paleta de colores, las opciones disponibles pueden buscarse ejecutando el comando <code><a href="https://rdrr.io/pkg/tmaptools/man/palette_explorer.html">tmaptools::palette_explorer()</a></code>. También se pueden adicionar otras herramientas de estadística descriptiva, como por ejemplo un histograma de frecuencia mediante el argumento <code>legend.hist = TRUE</code>. Los estilos de los ejes y leyendas se pueden modificar con la función <code><a href="https://rdrr.io/pkg/tmap/man/tm_layout.html">tm_layout()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">suelos_sf</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_symbols.html">tm_dots</a></span><span class="op">(</span></span>
<span>    <span class="st">"COS"</span>,</span>
<span>    style <span class="op">=</span> <span class="st">"quantile"</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>    palette <span class="op">=</span> <span class="st">"BuGn"</span>,</span>
<span>    legend.hist <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_layout.html">tm_layout</a></span><span class="op">(</span></span>
<span>    legend.format <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>text.separator <span class="op">=</span> <span class="st">" a "</span><span class="op">)</span>,</span>
<span>    legend.outside <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    legend.hist.width <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Parte3_cap_a_EscRegionImplR_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="regresión-con-errores-correlacionados-espacialmente-vía-reml" class="level2" data-number="8.1"><h2 data-number="8.1" class="anchored" data-anchor-id="regresión-con-errores-correlacionados-espacialmente-vía-reml">
<span class="header-section-number">8.1</span> Regresión con errores correlacionados espacialmente vía REML</h2>
<p>Se ajusta un modelo de regresión lineal con la función <code><a href="https://rdrr.io/pkg/nlme/man/gls.html">gls()</a></code>, usando COS como variable dependiente y elevación, twi, arcilla y pH como variables predictoras. Primero, se ajusta suponiendo errores independientes (sin correlación espacial). Los resultados se guardan en el objeto denominado <code>ajuste_ML</code>. Seguidamente, se ajusta otro modelo de regresión con igual estructura para la componente sistemática, pero suponiendo que los términos de error aleatorio no son independientes sino que se correlacionan a través de un modelo de covarianza espacial. En particular, se ajusta el modelo de correlación espacial esférico y se suponen varianza residual única (modelo homocedástico). El método de estimación del modelo es REML. Los resultados se guardan en el objeto <code>ajuste_err_corr</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ajuste_ML</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/gls.html">gls</a></span><span class="op">(</span></span>
<span>  <span class="va">COS</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">elevacion</span> <span class="op">+</span> <span class="va">twi</span> <span class="op">+</span> <span class="va">arcilla</span> <span class="op">+</span> <span class="va">pH</span>,</span>
<span>  data <span class="op">=</span> <span class="va">suelos</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"REML"</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ajuste_err_corr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/gls.html">gls</a></span><span class="op">(</span></span>
<span>  <span class="va">COS</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">elevacion</span> <span class="op">+</span> <span class="va">twi</span> <span class="op">+</span> <span class="va">arcilla</span> <span class="op">+</span> <span class="va">pH</span>,</span>
<span>  data <span class="op">=</span> <span class="va">suelos</span>,</span>
<span>  correlation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/corSpher.html">corSpher</a></span><span class="op">(</span>form <span class="op">=</span>  <span class="op">~</span> <span class="va">X</span> <span class="op">+</span> <span class="va">Y</span><span class="op">)</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"REML"</span></span>
<span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Utilizando la función <code><a href="https://rdrr.io/pkg/terra/man/summary.html">summary()</a></code> se muestra a continuación el resultado del modelo sin correlación espacial (<code>objeto ajuste_ML</code>). Todos los términos del modelo, a excepción de elevacion resultaron significativos para un nivel de significación <span class="math inline">\(\alpha=0.05\)</span>. Se observó una correlación alta entre elevacion y twi (0,859), por esta colinealidad entre ambas variables, el término elevacion pudo no haber resultado significativo y podría sacarse del modelo. Se muestra también las características de la distribución de los residuos (mínimo, máximo valor y principales cuartiles). Es de esperar que los residuos estandarizados se encuentren en el intervalo [-3, 3], los valores fuera de este rango se consideran valores atípicos y podrían ser eliminados para reajustar el modelo. La varianza residual es el cuadrado de 4.58, indicando que desviaciones de 4,58 g/kg pueden existir por azar y que no se relacionan a las fuentes de variación reconocidas a priori.</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/summary.html">summary</a></span><span class="op">(</span><span class="va">ajuste_ML</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Generalized least squares fit by REML
  Model: COS ~ 1 + elevacion + twi + arcilla + pH 
  Data: suelos 
      AIC      BIC   logLik
  2088.02 2111.081 -1038.01

Coefficients:
               Value Std.Error   t-value p-value
(Intercept) 37.17201  6.654919  5.585644  0.0000
elevacion    0.00349  0.002126  1.641544  0.1016
twi         -0.21008  0.046813 -4.487724  0.0000
arcilla      0.33407  0.030836 10.833750  0.0000
pH          -0.76640  0.381759 -2.007542  0.0455

 Correlation: 
          (Intr) elevcn twi    arcill
elevacion -0.767                     
twi       -0.919  0.859              
arcilla   -0.047 -0.001 -0.064       
pH        -0.347 -0.163 -0.035  0.040

Standardized residuals:
       Min         Q1        Med         Q3        Max 
-3.4274421 -0.5958947 -0.1180292  0.4724770  4.7869984 

Residual standard error: 4.58134 
Degrees of freedom: 350 total; 345 residual</code></pre>
</div>
</div>
<p>Para el modelo ajustado suponiendo errores correlacionados, los criterios de información de AIC y BIC fueron menores que los obtenidos bajo el supuesto de errores independientes, indicando la conveniencia de considerar la correlación espacial. Los parámetros del modelo asociado a la componente aleatoria son rango = 17791,35 m y varianza residual igual al cuadrado de 4,56. Estos caracterizan la matriz de varianza y covarianza de los errores y proveen una estimación del semivariograma esférico que describe el proceso espacial subyacente, <em>i.e.</em> observaciones separadas por más de 17791,35 m no se encuentran correlacionadas y la varianza residual de las observaciones independientes o con distancias mayor al rango, expresada como desvío estándar, es 4,56.</p>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/summary.html">summary</a></span><span class="op">(</span><span class="va">ajuste_err_corr</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Generalized least squares fit by REML
  Model: COS ~ 1 + elevacion + twi + arcilla + pH 
  Data: suelos 
       AIC      BIC    logLik
  2077.613 2104.518 -1031.806

Correlation Structure: Spherical spatial correlation
 Formula: ~X + Y 
 Parameter estimate(s):
   range 
17791.35 

Coefficients:
               Value Std.Error   t-value p-value
(Intercept) 36.97464  6.444078  5.737771  0.0000
elevacion    0.00363  0.002117  1.712655  0.0877
twi         -0.20331  0.046119 -4.408389  0.0000
arcilla      0.33384  0.026734 12.487196  0.0000
pH          -0.87070  0.361113 -2.411156  0.0164

 Correlation: 
          (Intr) elevcn twi    arcill
elevacion -0.763                     
twi       -0.916  0.853              
arcilla   -0.218  0.083  0.038       
pH        -0.285 -0.224 -0.108  0.260

Standardized residuals:
       Min         Q1        Med         Q3        Max 
-3.4154164 -0.5776356 -0.1173952  0.4755831  4.8429592 

Residual standard error: 4.565597 
Degrees of freedom: 350 total; 345 residual</code></pre>
</div>
</div>
<p>Las predicciones se realizaron utilizando la función <code><a href="https://rdrr.io/pkg/terra/man/predict.html">predict()</a></code> sobre los centroides de la grilla de predicción utilizando el mejor modelo entre los ajustados. Se convierte el objeto <code>centroide_pred</code> en un <code>data.frame</code>, eliminando del objeto <code>centroide_pred</code> la columna que contiene las características espaciales mediante la función <code><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_drop_geometry()</a></code> y extrayendo mediante la función <code><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html">st_coordinates()</a></code>, las coordenadas sin los atributos espaciales. Estas partes se guardan en el objeto <code>suelos_pred</code> de clase <code>data.frame</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">suelos_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_drop_geometry</a></span><span class="op">(</span><span class="va">centroide_pred</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html">st_coordinates</a></span><span class="op">(</span><span class="va">centroide_pred</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">pred_ajuste_err_corr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/predict.html">predict</a></span><span class="op">(</span></span>
<span>  <span class="va">ajuste_err_corr</span>,</span>
<span>  newdata <span class="op">=</span> <span class="va">suelos_pred</span>,</span>
<span>  na.action <span class="op">=</span> <span class="va">na.pass</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Los predichos se adicionan al objeto <code>centroide_pred</code> utilizando la función <code><a href="https://rdrr.io/r/base/cbind.html">cbind()</a></code>. Para que la visualización de estos valores, se pueda realizar utilizando los polígonos de la grilla de predicción en vez de los centroides, se deben adicionar los predichos mediante la función <code><a href="https://r-spatial.github.io/sf/reference/st_join.html">st_join()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pred_err_corr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span></span>
<span>  <span class="va">centroide_pred</span>,</span>
<span>  <span class="st">"COS_pred"</span> <span class="op">=</span> <span class="va">pred_ajuste_err_corr</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pred_err_corr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html">st_join</a></span><span class="op">(</span></span>
<span>  <span class="va">grilla_pred</span>,</span>
<span>  <span class="va">pred_err_corr</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">pred_err_corr</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_polygons.html">tm_fill</a></span><span class="op">(</span><span class="st">"COS_pred"</span>, style <span class="op">=</span> <span class="st">"cont"</span>,</span>
<span>          title <span class="op">=</span> <span class="st">"Predichos COS (g/kg)"</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Parte3_cap_a_EscRegionImplR_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section><section id="regresión-con-efectos-aleatorios-de-sitio-vía-inla" class="level2" data-number="8.2"><h2 data-number="8.2" class="anchored" data-anchor-id="regresión-con-efectos-aleatorios-de-sitio-vía-inla">
<span class="header-section-number">8.2</span> Regresión con efectos aleatorios de sitio vía INLA</h2>
<p>Para abordar la regresión bayesiana de datos espaciales, primero se define el predictor lineal ajustando un modelo de regresión lineal con la función <code><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla()</a></code>. INLA representa una combinación de aproximaciones analíticas y esquemas de integración numérica eficiente para obtener una aproximación confiable de la distribución a posteriori de interés. En el ejemplo de ilustración, se usa COS como variable dependiente y elevación, twi, arcilla y pH como variables predictoras y no se ha contemplado la estructura de correlación espacial. Se especifica la distribución que se asume para la variable respuesta a través del argumento <code>family</code>. El cómputo de las medidas para evaluación y comparación de modelos se realiza con el argumento <code>control.compute</code> especificando la medida que se pretende. Para explorar las opciones disponibles para la evaluación y comparación de modelos se ejecuta el comando <code><a href="https://rdrr.io/pkg/INLA/man/control.compute.html">?control.compute</a></code> (en el ejemplo, se solicita el criterio DIC).</p>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ajuste_INLA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span></span>
<span>  <span class="va">COS</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">elevacion</span> <span class="op">+</span> <span class="va">twi</span> <span class="op">+</span> <span class="va">arcilla</span> <span class="op">+</span> <span class="va">pH</span>,</span>
<span>  family <span class="op">=</span> <span class="st">'gaussian'</span>,</span>
<span>  data <span class="op">=</span> <span class="va">suelos</span>,</span>
<span>  control.compute <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>dic <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>El modelo ajustado es retornado como un objeto INLA. Este provee información sobre el tiempo de procesado y algunos estadísticos sobre las distribuciones a posteriori de los coeficientes de regresión (efectos fijos) y de los hiperparámetros. Para el modelo ajustado se observan los intervalos de credibilidad del 95% para los coeficientes de regresión asociados a cada una de las variables predictoras (predictor lineal) y como hiperparámetro la precisión de las observaciones de COS. En este ajuste, no hubo efectos aleatorios ni especificaciones relacionadas a la espacialidad de los datos. El intervalo de credibilidad contiene al verdadero parámetro con un 95% de probabilidad. Luego, el ajusta indica que todas las variables impactan a la respuesta, excepto la variable elevación para la cual el desvío estándar (sd) es alto relativo a la media de la distribución del coeficiente de regresión y el intervalo de credibilidad contiene al 0. Podría ser oportuno realizar un nuevo ajuste sin esta variable, que como se ha especificado anteriormente está altamente correlacionada con twi. La media a posteriori para el coeficiente de regresión que acompaña el pH es -0,766 con un intervalo de credibilidad del 95% entre -1,515 y -0,018, por lo que se interpreta que a mayores valores de pH se tendrán menores valores de COS. Se muestra también el intervalo de credibilidad [0,041; 0,055] para la precisión (inversa de la varianza <span class="math inline">\(1/\sigma_e^2\)</span> ), la estimación es 0,048 y por tanto la varianza residual es próxima a 20 o el error estándar residual cercano a 4,56. El valor de DIC, el cual es una función de la deviance del modelo y de una medida del número efectivo de parámetros del modelo, es 2065,79. El numero efectivo de parámetros es una cantidad que caracteriza la complejidad del modelo y que no solo depende de la cantidad de parámetros sino también de la dependencia entre ellos. Esta medida puede ser usada para comparar modelos, menores valores indican mejor ajuste del modelo a los datos. El mejor de los modelos ajustados, también tendrá menor diferencia entre el valor de DIC para ese modelo y el valor de DIC para el modelo saturado. La verosimilitud marginal es otro criterio usado en selección de modelos en estadística bayesiana, al reportarse en escala log menor valor indica mejor ajuste. R-INLA obtiene las distribuciones marginales a posteriori para todos los parámetros del modelo.</p>
<div class="cell">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/summary.html">summary</a></span><span class="op">(</span><span class="va">ajuste_INLA</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
   c("inla.core(formula = formula, family = family, contrasts = contrasts, 
   ", " data = data, quantiles = quantiles, E = E, offset = offset, ", " 
   scale = scale, weights = weights, Ntrials = Ntrials, strata = strata, 
   ", " lp.scale = lp.scale, link.covariates = link.covariates, verbose = 
   verbose, ", " lincomb = lincomb, selection = selection, control.compute 
   = control.compute, ", " control.predictor = control.predictor, 
   control.family = control.family, ", " control.inla = control.inla, 
   control.fixed = control.fixed, ", " control.mode = control.mode, 
   control.expert = control.expert, ", " control.hazard = control.hazard, 
   control.lincomb = control.lincomb, ", " control.update = 
   control.update, control.lp.scale = control.lp.scale, ", " 
   control.pardiso = control.pardiso, only.hyperparam = only.hyperparam, 
   ", " inla.call = inla.call, inla.arg = inla.arg, num.threads = 
   num.threads, ", " blas.num.threads = blas.num.threads, keep = keep, 
   working.directory = working.directory, ", " silent = silent, inla.mode 
   = inla.mode, safe = FALSE, debug = debug, ", " .parent.frame = 
   .parent.frame)") 
Time used:
    Pre = 0.491, Running = 0.668, Post = 0.115, Total = 1.27 
Fixed effects:
              mean    sd 0.025quant 0.5quant 0.975quant   mode kld
(Intercept) 37.171 6.650     24.122   37.171     50.221 37.171   0
elevacion    0.003 0.002     -0.001    0.003      0.008  0.003   0
twi         -0.210 0.047     -0.302   -0.210     -0.118 -0.210   0
arcilla      0.334 0.031      0.274    0.334      0.395  0.334   0
pH          -0.766 0.381     -1.515   -0.766     -0.018 -0.766   0

Model hyperparameters:
                                         mean    sd 0.025quant 0.5quant
Precision for the Gaussian observations 0.048 0.004      0.041    0.048
                                        0.975quant  mode
Precision for the Gaussian observations      0.055 0.048

Deviance Information Criterion (DIC) ...............: 2065.62
Deviance Information Criterion (DIC, saturated) ....: 358.50
Effective number of parameters .....................: 6.00

Marginal log-Likelihood:  -1070.11 
 is computed 
Posterior summaries for the linear predictor and the fitted values are computed
(Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</code></pre>
</div>
</div>
<p>Los efectos aleatorios en INLA se incluyen en la formula del predictor lineal usando la función <code><a href="https://rdrr.io/pkg/INLA/man/f.html">f()</a></code>. Para el ejemplo de ilustración, más abajo se ajusta el modelo de regresión donde se adiciona un efecto aleatorio de sitio para caracterizar el proceso espacial subyacente a los datos. Dado que la función <code><a href="https://rdrr.io/pkg/INLA/man/f.html">f()</a></code> se valúa sobre un red de nodos conformada a partir de las observaciones, es primero necesario construir una malla que cubra el dominio espacial y definir un objeto que contiene la identificación de los nodos con observaciones. La malla se arma con la función <code><a href="https://rdrr.io/pkg/INLA/man/inla.mesh.2d.html">inla.mesh.2d()</a></code> cuyos argumentos o parámetros de la malla son: <code>cutoff</code> define la distancia mínima entre vértices de los triángulos que conforman la malla y <code>max.edge</code> que refiere a la longitud máxima del lado de cada triángulo. Por defecto, la malla se construye con el método de triangulación de Delauny.</p>
<div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sitios</span> <span class="op">&lt;-</span> <span class="va">suelos</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">malla</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.mesh.2d.html">inla.mesh.2d</a></span><span class="op">(</span><span class="va">sitios</span>, cutoff <span class="op">=</span> <span class="fl">200</span>,</span>
<span>                      max.edge <span class="op">=</span> <span class="fl">200000</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Para estimar la matriz de varianzas y covarianzas de los efectos de sitio por el método SPDE se utiliza la función <code><a href="https://rdrr.io/pkg/INLA/man/inla.spde2.matern.html">inla.spde2.matern()</a></code>. Un argumento a especificar es el parámetro <span class="math inline">\(\alpha\)</span> (que varía entre 0 y 2). Por defecto es 2 para aproxima una función de correlación espacial del tipo exponencial como modelo de correlación espacial entre los efectos de sitio.</p>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">spde</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.spde2.matern.html">inla.spde2.matern</a></span><span class="op">(</span>mesh <span class="op">=</span> <span class="va">malla</span>,</span>
<span>                          alpha <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Otra función posible es <code>inla.spde2.pcmatern</code>, en la cual hay que especificar el rango (argumetno <code>prior.range</code>) y desvío estándar marginal (argumetno <code>prior.sigma</code>) a priori. Para ambos argumentos hay que especificarle un vector de largo dos. En el caso de <code>prior.range</code> los valores contienen el range0 y Prange, especificando que <span class="math inline">\(P(\rho &lt; \rho_0) = p_\rho\)</span>, donde <span class="math inline">\(\rho\)</span> es el rando espacial del campo aleatorio. El argumento <code>prior.sigma</code> se especifica de tal manera que <span class="math inline">\(P(\sigma &gt; \sigma_0) = p_\rho\)</span>, donde <span class="math inline">\(\sigma\)</span> es la desviación estándar residual del campo.</p>
<!-- https://groups.google.com/g/r-inla-discussion-group/c/dunoXK_yAco -->
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">spde</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.spde2.pcmatern.html">inla.spde2.pcmatern</a></span><span class="op">(</span></span>
<span>  mesh <span class="op">=</span> <span class="va">malla</span>,</span>
<span>  prior.range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20000</span>, <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>  prior.sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.05</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Luego de realizar la malla y crear el objeto del modelo Matern, se ajusta el modelo de regresión con efecto aleatorio de sitio. En esta ilustración se ajustará utilizando tanto la función <code><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla()</a></code> del paquete <code>INLA</code>, como así también la función <code><a href="https://inlabru-org.github.io/inlabru/reference/bru.html">bru()</a></code> del paquete <code>inlabru</code>. Con ambas funciones se obtendrá el mismo modelo, por lo que se debería seleccionar una única alternativa.</p>
<p>El paquete <code>inlabru</code> fue desarrollado para facilitar la modelación espacial utilizando funciones del paquete <code>INLA</code>, por lo que crearemos un objeto espacial llamado <code>suelos_sf</code> para la función que pueda identificar los sitios y el sistema de coordenadas de manera automática. Los resultados son un objeto INLA que incluyen las distribuciones a posteriori de los efectos latentes y de los hiperparámetros, así como estadísticos de resumen. Como se ejemplifica adelante, pueden obtenerse estimaciones a posteriori de parámetros del campo espacial latente. La fórmula es similar a la especificada anteriormente, pero se adiciona el efecto de sitio llamado <code>site</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">suelos_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="va">suelos</span>, </span>
<span>                      coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span>, </span>
<span>                      crs <span class="op">=</span> <span class="fl">32720</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ajuste_INLAspde</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://inlabru-org.github.io/inlabru/reference/bru.html">bru</a></span><span class="op">(</span></span>
<span>    <span class="va">COS</span> <span class="op">~</span> </span>
<span>      <span class="fu">Intercept</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="va">elevacion</span> <span class="op">+</span> <span class="va">twi</span> <span class="op">+</span> </span>
<span>      <span class="va">arcilla</span> <span class="op">+</span> <span class="va">pH</span> <span class="op">+</span> </span>
<span>      <span class="fu">site</span><span class="op">(</span>main <span class="op">=</span> <span class="va">coordinates</span>, model <span class="op">=</span> <span class="va">spde</span><span class="op">)</span>,</span>
<span>    family <span class="op">=</span> <span class="st">"gaussian"</span>,</span>
<span>    data <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/coerce-methods.html">as_Spatial</a></span><span class="op">(</span><span class="va">suelos_sf</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>En el caso de utilizar la función <code><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla()</a></code>, es necesario especificar los sitios donde se encuentras las observaciones, para esto se generará el objeto <code>site</code> a partir de los sitios de la <code>malla</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">site</span> <span class="op">&lt;-</span> <span class="va">malla</span><span class="op">$</span><span class="va">idx</span><span class="op">$</span><span class="va">loc</span></span>
<span></span>
<span><span class="va">ajuste_INLAspde_inla</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span></span>
<span>  <span class="va">COS</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">elevacion</span> <span class="op">+</span> <span class="va">twi</span> <span class="op">+</span> <span class="va">arcilla</span> <span class="op">+</span> <span class="va">pH</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">site</span>, model <span class="op">=</span> <span class="va">spde</span><span class="op">)</span>,</span>
<span>  family <span class="op">=</span> <span class="st">'gaussian'</span>,</span>
<span>  data <span class="op">=</span> <span class="va">suelos</span>,</span>
<span>  control.compute <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>dic <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  control.predictor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>compute <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/summary.html">summary</a></span><span class="op">(</span><span class="va">ajuste_INLAspde</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>inlabru version: 2.7.0
INLA version: 22.12.16
Components:
Intercept: main = linear(1)
elevacion: main = linear(elevacion)
twi: main = linear(twi)
arcilla: main = linear(arcilla)
pH: main = linear(pH)
site: main = spde(coordinates)
Likelihoods:
  Family: 'gaussian'
    Data class: 'SpatialPointsDataFrame'
    Predictor: COS ~ .
Time used:
    Pre = 1.04, Running = 0.452, Post = 0.167, Total = 1.66 
Fixed effects:
            mean    sd 0.025quant 0.5quant 0.975quant   mode kld
Intercept 41.445 6.525     28.633   41.448     54.239 41.454   0
elevacion  0.005 0.002      0.000    0.005      0.009  0.005   0
twi       -0.219 0.045     -0.307   -0.219     -0.131 -0.219   0
arcilla    0.233 0.039      0.157    0.233      0.308  0.233   0
pH        -1.038 0.377     -1.776   -1.039     -0.299 -1.039   0

Random effects:
  Name    Model
    site SPDE2 model

Model hyperparameters:
                                            mean       sd 0.025quant 0.5quant
Precision for the Gaussian observations 5.70e-02 5.00e-03   4.80e-02 5.70e-02
Range for site                          3.42e+05 1.06e+05   1.77e+05 3.28e+05
Stdev for site                          9.60e-01 2.19e-01   5.83e-01 9.43e-01
                                        0.975quant     mode
Precision for the Gaussian observations   6.60e-02 5.60e-02
Range for site                            5.91e+05 3.01e+05
Stdev for site                            1.44e+00 9.13e-01

Deviance Information Criterion (DIC) ...............: 2015.13
Deviance Information Criterion (DIC, saturated) ....: 366.79
Effective number of parameters .....................: 13.66

Watanabe-Akaike information criterion (WAIC) ...: 2020.41
Effective number of parameters .................: 17.93

Marginal log-Likelihood:  -1071.64 
 is computed 
Posterior summaries for the linear predictor and the fitted values are computed
(Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</code></pre>
</div>
</div>
<p>El objeto resultante provee información sobre los intervalos de credibilidad del 95% de los coeficientes de regresión y de los hiperparámetros. Estos son además de la precisión <code>Theta1</code> y <code>Theta2</code> que definen la función de correlación espacial subyacente. Los parámetros <code>Theta1</code> y <code>Theta2</code> no son de interpretación directa, pero dependen de los parámetros que caracterizan el proceso espacial (rango y varianza estructural). Utilizando la función <code><a href="https://rdrr.io/pkg/INLA/man/inla.spde.result.html">inla.spde2.result()</a></code> se puede obtener la distribución a posteriori de los parámetros expresadas en términos de rango y varianza estructural.</p>
<!-- ```{r, echo=FALSE, purl=FALSE} -->
<!-- options(OutDec = ".") -->
<!-- ``` -->
<div class="cell">
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">resultados_spde</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.spde.result.html">inla.spde2.result</a></span><span class="op">(</span>inla <span class="op">=</span> <span class="va">ajuste_INLAspde</span>,</span>
<span>                    name <span class="op">=</span> <span class="st">"site"</span>, spde <span class="op">=</span> <span class="va">spde</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/marginal.html">inla.emarginal</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="va">x</span><span class="op">}</span>,</span>
<span>  <span class="va">resultados_spde</span><span class="op">$</span><span class="va">marginals.range.nominal</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 342057.7</code></pre>
</div>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/marginal.html">inla.emarginal</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="va">x</span><span class="op">}</span>,</span>
<span>  <span class="va">resultados_spde</span><span class="op">$</span><span class="va">marginals.variance.nominal</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9689066</code></pre>
</div>
</div>
<!-- ```{r, echo=FALSE, purl=FALSE} -->
<!-- options(OutDec = ",") -->
<!-- ``` -->
<p>Para comparar los modelos de regresión ajustados con errores independientes y con correlación espacial se visualizan medidas de bondad de ajuste como DIC para ambos modelos.</p>
<div class="cell">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ajuste_INLA</span><span class="op">$</span><span class="va">dic</span><span class="op">$</span><span class="va">dic</span>, <span class="va">ajuste_INLAspde</span><span class="op">$</span><span class="va">dic</span><span class="op">$</span><span class="va">dic</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2065.624 2015.131</code></pre>
</div>
</div>
<p>Comparando los valores de DIC se observa la conveniencia de usar un modelo con correlación espacial respecto a uno que supone los valores de COS independientes, dado que el primero tiene un valor menor.</p>
<section id="obtención-de-predicciones" class="level3" data-number="8.2.1"><h3 data-number="8.2.1" class="anchored" data-anchor-id="obtención-de-predicciones">
<span class="header-section-number">8.2.1</span> Obtención de predicciones</h3>
<p>Para obtener predicciones se puede utilizar tanto funciones del paquete <code>inlabru</code> o bien específicas del paquete <code>INLA</code>. Aquí, a modo ilustrativo, se presentan ambas formas de obtener los mismos predichos, aunque el usuario deberá optar por la de su conveniencia. Para ambas alternativas es necesario contar con un objeto que contenga los sitios en los que queremos realizar las predicciones. En el caso de no utilizar funciones de <code>inlabru</code> es necesario que este objeto contenga tanto información de los sitios a predecir como los datos de los sitios observados. La función <code>bind_rows()</code> del paquete <code>dplyr</code> permite juntar dos objetos de clase <code>data.frame</code> que contengan el mismo nombre de columnas colocando <code>NA</code> cuando no hay valor para un campo.</p>
<div class="cell">
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">suelos_pred_INLA</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="va">suelos_pred</span>,</span>
<span>                                     <span class="va">suelos</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/headtail.html">head</a></span><span class="op">(</span><span class="va">suelos_pred_INLA</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          UNION JURISDICCI CAPITAL FUENTE elevacion      twi       pH   arcilla
1   -2147483648    CORDOBA CORDOBA    IGN  274.8449 118.4764 6.391590  8.209237
1.1 -2147483648    CORDOBA CORDOBA    IGN  257.2227 113.7088 6.262683  8.882079
1.2 -2147483648    CORDOBA CORDOBA    IGN  266.5454 112.7255 6.142890  9.475647
1.3 -2147483648    CORDOBA CORDOBA    IGN  255.0000 118.6159 6.136549  9.945969
1.4 -2147483648    CORDOBA CORDOBA    IGN  230.9800 119.1276 5.946674 10.268174
1.5 -2147483648    CORDOBA CORDOBA    IGN  201.1941 118.7030 5.782518 10.445782
           X       Y ID_2 COS
1   310498.8 6129968   NA  NA
1.1 319332.6 6130045   NA  NA
1.2 329333.4 6130153   NA  NA
1.3 339337.7 6130238   NA  NA
1.4 349337.5 6130314   NA  NA
1.5 359337.5 6130390   NA  NA</code></pre>
</div>
</div>
</section></section><section id="predicciones-utilizando-el-paquete-inlabru" class="level2" data-number="8.3"><h2 data-number="8.3" class="anchored" data-anchor-id="predicciones-utilizando-el-paquete-inlabru">
<span class="header-section-number">8.3</span> Predicciones utilizando el paquete <code>inlabru</code>
</h2>
<p>El paquete <code>inlabru</code> contiene una función <code>predict</code> la cual puede ser utilizada para obtener las predicciones. Transformaremos el objeto <code>suelos_pred_INLA</code> en uno de clase espacial. Para utilizar esta función, el modelo debe ajustarse mediante la función <code><a href="https://inlabru-org.github.io/inlabru/reference/bru.html">bru()</a></code>. Mediante una fórmula, es necesario especificar los efectos que queremos considerar para la predicción, en este caso consideraremos todos los efectos del ajuste.</p>
<div class="cell">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">suelos_pred_INLA_sf</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="va">suelos_pred_INLA</span>, </span>
<span>           coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span>, </span>
<span>           crs <span class="op">=</span> <span class="fl">32720</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pred_INLAspde_bru</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/terra/man/predict.html">predict</a></span><span class="op">(</span></span>
<span>    <span class="va">ajuste_INLAspde</span>,</span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/coerce-methods.html">as_Spatial</a></span><span class="op">(</span><span class="va">suelos_pred_INLA_sf</span><span class="op">)</span>,</span>
<span>    <span class="op">~</span> <span class="va">Intercept</span> <span class="op">+</span> <span class="va">elevacion</span> <span class="op">+</span> </span>
<span>      <span class="va">twi</span> <span class="op">+</span> <span class="va">arcilla</span> <span class="op">+</span> <span class="va">pH</span> <span class="op">+</span> <span class="va">site</span></span>
<span>  <span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Los predichos pueden ser graficados utilizando el paquete <code>ggplot2</code> y la función <code><a href="https://inlabru-org.github.io/inlabru/reference/gg.html">gg()</a></code> del paquete <code>inlabru.</code></p>
<div class="cell">
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://inlabru-org.github.io/inlabru/reference/gg.html">gg</a></span><span class="op">(</span><span class="va">pred_INLAspde_bru</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">mean</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html">coord_equal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"X"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Y"</span>,</span>
<span>       color <span class="op">=</span> <span class="st">"COS predicho"</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Parte3_cap_a_EscRegionImplR_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section><section id="utilizando-inla" class="level2" data-number="8.4"><h2 data-number="8.4" class="anchored" data-anchor-id="utilizando-inla">
<span class="header-section-number">8.4</span> Utilizando <code>INLA</code>
</h2>
<p>En R-INLA no existe una funcion <code><a href="https://rdrr.io/pkg/terra/man/predict.html">predict()</a></code> como en gls. Las predicciones deben ser obtenidas como parte del modelo ajustado. Dado que las predicciones puedes ser entendidas como el ajuste de un modelo con datos faltantes simplemente se especificará, antes del ajuste, <code>y[i] = NA</code> para aquellos sitios donde se desea predecir. Las distribuciones de los valores predichos no son devueltas directamente, pero se pueden explorar. <code>INLA</code> retorna las a posteriori marginales para los efectos aleatorios y para el predictor linear en el sitio faltante. Adicionando el ruido de las observaciones a los valores ajustados se obtienen los valores predichos para el sitio.</p>
<p>Luego de identificar el predictor lineal, debe definirse la malla y el modelo espacial para la grilla de predicción asociada a los efectos aleatorios de sitios. Mediante el argumento <code>control.predictor</code> en la función <code><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla()</a></code> se indica que debe computarse el valor de la variable respuesta en el lugar del dato faltante.</p>
<div class="cell">
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sitios_pred</span> <span class="op">&lt;-</span> <span class="va">suelos_pred_INLA</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span><span class="op">]</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">malla_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.mesh.2d.html">inla.mesh.2d</a></span><span class="op">(</span>loc <span class="op">=</span> <span class="va">sitios_pred</span>, </span>
<span>                           cutoff <span class="op">=</span> <span class="fl">200</span>,</span>
<span>                           max.edge <span class="op">=</span> <span class="fl">200000</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nodos_pred</span> <span class="op">&lt;-</span> <span class="va">malla_pred</span><span class="op">$</span><span class="va">idx</span><span class="op">$</span><span class="va">loc</span></span>
<span></span>
<span><span class="va">spde_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.spde2.pcmatern.html">inla.spde2.pcmatern</a></span><span class="op">(</span></span>
<span>  mesh <span class="op">=</span> <span class="va">malla_pred</span>,</span>
<span>  prior.range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20000</span>, <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>  prior.sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.05</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">pred_INLAspde</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span></span>
<span>    <span class="va">COS</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">elevacion</span> <span class="op">+</span> <span class="va">twi</span> <span class="op">+</span> </span>
<span>      <span class="va">arcilla</span> <span class="op">+</span> <span class="va">pH</span> <span class="op">+</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">nodos_pred</span>, </span>
<span>        model <span class="op">=</span> <span class="va">spde_pred</span>, </span>
<span>        diagonal <span class="op">=</span> <span class="fl">1e-6</span><span class="op">)</span>,</span>
<span>    family <span class="op">=</span> <span class="st">'gaussian'</span>,</span>
<span>    data <span class="op">=</span> <span class="va">suelos_pred_INLA</span>,</span>
<span>    control.predictor <span class="op">=</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>link <span class="op">=</span> <span class="fl">1</span>, compute <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Se puede obtener la media de la distribución a posteriori de los valores predichos para cada sitio en la grilla de predicción, para mapear la distribución espacial de la variable respuesta.</p>
<div class="cell">
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">COS_pred_INLA</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">pred_INLAspde</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">$</span><span class="va">mean</span></span>
<span></span>
<span><span class="va">COS_pred_inlabru</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">pred_INLAspde_bru</span><span class="op">$</span><span class="va">mean</span></span>
<span></span>
<span><span class="va">pred_err_corr</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span></span>
<span>    <span class="va">suelos_pred_INLA_sf</span>,</span>
<span>    <span class="st">"COS_pred_INLA"</span> <span class="op">=</span> <span class="va">COS_pred_INLA</span>,</span>
<span>    <span class="st">"COS_pred_inlabru"</span> <span class="op">=</span> <span class="va">COS_pred_inlabru</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="va">map_pred_inla</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">pred_err_corr</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_symbols.html">tm_dots</a></span><span class="op">(</span><span class="st">"COS_pred_INLA"</span>, style <span class="op">=</span> <span class="st">"cont"</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">map_pred_inlabru</span> <span class="op">&lt;-</span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">pred_err_corr</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_symbols.html">tm_dots</a></span><span class="op">(</span><span class="st">"COS_pred_inlabru"</span>, style <span class="op">=</span> <span class="st">"cont"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tmap_arrange.html">tmap_arrange</a></span><span class="op">(</span><span class="va">map_pred_inla</span>, </span>
<span>             <span class="va">map_pred_inlabru</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Parte3_cap_a_EscRegionImplR_files/figure-html/unionpredichosinla-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section><section id="regresión-vía-modelos-basados-en-árbol" class="level2" data-number="8.5"><h2 data-number="8.5" class="anchored" data-anchor-id="regresión-vía-modelos-basados-en-árbol">
<span class="header-section-number">8.5</span> Regresión vía modelos basados en árbol</h2>
<p>Se ajusta un modelo GBR o <em>gradient boosting model</em> con errores correlacionados espacialmente en dos pasos, primero se optimiza la parametrización del predictor GBR usando datos de los sitios observados y se obtienen los residuos de este modelo. En segunda instancia, se ajusta un modelo de semivariaograma a los residuos que se usará para realizar predicción kriging de residuos sobre toda la grilla de predicción. Finalmente, los residuos predichos se adicional a la componente sistemática predicha con el modelo GBR sobre la misma grilla de predicción.</p>
<p>Para implementar GBR se utiliza el paquete <code>caret</code>. Para optimizar el modelo GBM. se genera una grilla de valores posibles para sus parámetros con la función <code><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid()</a></code>. Esta función genera un <code>data.frame</code> que contiene en las filas cada una de las combinaciones posibles generadas a partir de los rangos de valores propuestos para cada parámetro del modelo GBM. Éstos son: <code>n.trees</code> que definen el número total de árboles ajustados, <code>shrinkage</code> que regula la extensión de cada árbol, <code>n.minobsinnode</code> que representa el mínimo de observaciones en cada nodo terminal y <code>bag.fraction</code> la proporción de observaciones del grupo de entrenamiento seleccionadas aleatoriamente para la expansión sucesiva del árbol. El tipo de validación cruzada para la optimización de los parámetros del modelo se realiza a través de la función <code>train.control</code>. Luego utilizando la función <code><a href="https://rdrr.io/pkg/caret/man/train.html">train()</a></code> se especifica el modelo con el argumento <code>method</code>, en este caso <code>gbm.</code> La misma función <code><a href="https://rdrr.io/pkg/caret/man/train.html">train()</a></code> genera un objeto con el modelo parametrizado con la configuración valores que arrojan el menor error predictivo, es decir con un modelo del tipo árbol optimizado.</p>
<div class="cell">
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">param_gbm</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span></span>
<span>  interaction.depth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span>,</span>
<span>  n.trees <span class="op">=</span> <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>,</span>
<span>  shrinkage <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.001</span>, <span class="fl">0.01</span><span class="op">)</span>,</span>
<span>  n.minobsinnode <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">7</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">control</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"repeatedcv"</span>,</span>
<span>                        number <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                        repeats <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ajuste_gbm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html">train</a></span><span class="op">(</span></span>
<span>  <span class="va">COS</span> <span class="op">~</span> <span class="va">elevacion</span> <span class="op">+</span> <span class="va">twi</span> <span class="op">+</span> <span class="va">arcilla</span> <span class="op">+</span> <span class="va">pH</span>,</span>
<span>  data <span class="op">=</span> <span class="va">suelos</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"gbm"</span>,</span>
<span>  trControl <span class="op">=</span> <span class="va">control</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  metric <span class="op">=</span> <span class="st">"RMSE"</span>,</span>
<span>  tuneGrid <span class="op">=</span> <span class="va">param_gbm</span></span>
<span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Pidiendo un gráfico del objeto <code>ajuste_gbm</code> se puede acceder al resumen del proceso de optimización de los parámetros. El rendimiento del modelo depende de estos parámetros, pero es posible identificar las combinaciones que generan el mejor desempeño predictivo. A su vez, a través del comando <code>ajuste_gbm$bestTune</code> podemos acceder a los parámetros que definen el modelo óptimo.</p>
<div class="cell">
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">ajuste_gbm</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Parte3_cap_a_EscRegionImplR_files/figure-html/mejorajustegbm_plot-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ajuste_gbm</span><span class="op">$</span><span class="va">bestTune</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    n.trees interaction.depth shrinkage n.minobsinnode
173    2300                 4     0.001              7</code></pre>
</div>
</div>
<p>El objeto resultante del ajuste GBM, provee un gráfico de la influencia relativa de cada variable predictora para explicar COS, y el árbol con el que se realizará la predicción. A partir de la función <code><a href="https://rdrr.io/pkg/terra/man/predict.html">predict()</a></code> sobre los datos observados, se obtienen predichos y consecuentemente los residuos del modelo GBR.</p>
<div class="cell">
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/summary.html">summary</a></span><span class="op">(</span><span class="va">ajuste_gbm</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Parte3_cap_a_EscRegionImplR_files/figure-html/resumenajustegbm-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                var   rel.inf
twi             twi 39.342667
arcilla     arcilla 38.700249
elevacion elevacion 13.873191
pH               pH  8.083893</code></pre>
</div>
</div>
<p>En la segunda etapa, se ajusta una función de semivarianza a los residuos del modelo GBM utilizando las funciones <code>variogram</code> y <code>fit.variogram</code> del paquete <code>gstat</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">suelos</span><span class="op">$</span><span class="va">residuosgbm</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">suelos</span><span class="op">$</span><span class="va">COS</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/predict.html">predict</a></span><span class="op">(</span><span class="va">ajuste_gbm</span>, </span>
<span>                       newdata <span class="op">=</span> <span class="va">suelos</span><span class="op">)</span></span>
<span><span class="va">suelos</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="va">suelos</span>, </span>
<span>           coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span>, </span>
<span>           crs <span class="op">=</span> <span class="fl">32720</span><span class="op">)</span></span>
<span></span>
<span><span class="va">semiv_gbmk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gstat/man/variogram.html">variogram</a></span><span class="op">(</span><span class="va">residuosgbm</span> <span class="op">~</span> <span class="fl">1</span>, <span class="va">suelos</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">semiv_gbmk</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Parte3_cap_a_EscRegionImplR_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">semiv_aj_gbmk</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/gstat/man/fit.variogram.html">fit.variogram</a></span><span class="op">(</span><span class="va">semiv_gbmk</span> ,</span>
<span>                <span class="fu"><a href="https://rdrr.io/pkg/gstat/man/vgm.html">vgm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Exp"</span>, <span class="st">"Sph"</span>, <span class="st">"Gau"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">semiv_gbmk</span>, <span class="va">semiv_aj_gbmk</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Parte3_cap_a_EscRegionImplR_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Para obtener un predicción de COS en los sitios no muestreados, se realiza la predicción kriging de los residuos sobre los sitios de la grilla de predicción utilizando el modelo ajustado en el paso anterior a partir de la función <code><a href="https://rdrr.io/pkg/gstat/man/krige.html">krige()</a></code>. Luego se utiliza el modelo GBM (árbol optimo) para predecir COS sobre la grilla de predicción sin considerar la espacialidad. Finalmente, la predicción de COS en cada sitio se compone sumando la predicción del modelo GBM y la predicción kriging de los residuos para cada sitio de la grilla de predicción.</p>
<div class="cell">
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">krig_res_gbm</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/gstat/man/krige.html">krige</a></span><span class="op">(</span></span>
<span>    <span class="va">residuosgbm</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>    location <span class="op">=</span> <span class="va">suelos</span>,</span>
<span>    newdata <span class="op">=</span> <span class="va">pred_err_corr</span>,</span>
<span>    model <span class="op">=</span> <span class="va">semiv_aj_gbmk</span></span>
<span>  <span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[using ordinary kriging]</code></pre>
</div>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">gbmk_pred</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/terra/man/predict.html">predict</a></span><span class="op">(</span><span class="va">ajuste_gbm</span>,</span>
<span>          newdata <span class="op">=</span> <span class="va">pred_err_corr</span>, </span>
<span>          na.action <span class="op">=</span> <span class="va">na.pass</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">krig_res_gbm</span><span class="op">$</span><span class="va">var1.pred</span></span>
<span></span>
<span><span class="va">pred_err_corr</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">pred_err_corr</span>,</span>
<span>        <span class="st">"COS_pred_GBM"</span> <span class="op">=</span> <span class="va">gbmk_pred</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">pred_err_corr</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_symbols.html">tm_dots</a></span><span class="op">(</span><span class="st">"COS_pred_GBM"</span>, style <span class="op">=</span> <span class="st">"cont"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_layout.html">tm_layout</a></span><span class="op">(</span>legend.outside <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Parte3_cap_a_EscRegionImplR_files/figure-html/predichosgbm-1.png" class="img-fluid" width="672"></p>
</div>
</div>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography" style="display: none">
<div id="ref-Hang2015" class="csl-entry" role="doc-biblioentry">
Hang, Susana, Gustavo Negro, Alejandro Becerra, y Ariel Edgar Rampoldi. 2015. <em><span>Suelos de C<span>ó</span>rdoba: Variabilidad de las propiedades del horizonte superficial.</span></em> C<span>ó</span>rdoba: Jorge Omar Editorial.
</div>
</div>
</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copiado");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copiado");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./Parte2_cap_b_EscFinaImplInfo.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Implementación con InfoStat</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./referencias.html" class="pagination-link">
        <span class="nav-page-text">Referencias</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Ejecutar el código</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb69" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Bases de datos regionales</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a><span class="co">#| results: "asis"</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"_common.R"</span>)</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>Muchos procesos aleatorios varían de manera continua en el espacio a escala regional. Entonces, es de interés predecir el comportamiento de una variable en referencia a su ubicación geográfica. En algunas situaciones además de la distribución en el espacio otras capas de información (covariables de sitio) pueden ser usadas para mejorar la predicción en un sitio específico. En esta parte se ilustran el manejo de datos espaciales para la predicción a escala regional de una variable a partir de múltiples capas de información y la construcción de un modelo de predicción espacial vía estrategias metodológicas alternativas: regresión múltiple vía REML, regresión múltiple vía INLA y regresión no lineal vía modelo basado en árbol. </span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>Como ejemplo se utiliza la base de datos **suelos_cba.txt**. Esta es una parte del SIG de los suelos del horizonte superficial de la provincia Córdoba [@Hang2015], que contiene 350 sitios caracterizados por múltiples variables edáficas que describen los primeros 15 cm de profundidad. Las variables presentes en **suelos_cba.txt** son: COS (Carbono Orgánico de Suelo, g\/kg) arcilla (\%), pH, elevación (m.s.n.m.), twi (Índice Topográfico de Humedad). El objetivo del análisis es ajustar modelos que expliquen la variabilidad espacial de COS en función de las restantes variables en la base de datos.</span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>Para seguir la ilustración, cargar los paquetes específicos de R que albergan las funciones que se utilizarán tanto para el manejo como para la modelación.</span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE, echo = FALSE}</span></span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a><span class="fu">tryCatch</span>(</span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(INLA),</span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">error =</span> <span class="cf">function</span> (e) {</span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(</span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a>      <span class="st">"INLA"</span>,</span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">repos =</span> <span class="fu">c</span>(<span class="fu">getOption</span>(<span class="st">"repos"</span>), <span class="at">INLA =</span> <span class="st">"https://inla.r-inla-download.org/R/stable"</span>),</span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">dep =</span> <span class="cn">TRUE</span></span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb69-27"><a href="#cb69-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb69-28"><a href="#cb69-28" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-29"><a href="#cb69-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-30"><a href="#cb69-30" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-31"><a href="#cb69-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-32"><a href="#cb69-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-33"><a href="#cb69-33" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE}</span></span>
<span id="cb69-34"><a href="#cb69-34" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb69-35"><a href="#cb69-35" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb69-36"><a href="#cb69-36" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tmap)</span>
<span id="cb69-37"><a href="#cb69-37" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nlme)</span>
<span id="cb69-38"><a href="#cb69-38" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(INLA)</span>
<span id="cb69-39"><a href="#cb69-39" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(inlabru)</span>
<span id="cb69-40"><a href="#cb69-40" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb69-41"><a href="#cb69-41" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gstat)</span>
<span id="cb69-42"><a href="#cb69-42" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-43"><a href="#cb69-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-44"><a href="#cb69-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-45"><a href="#cb69-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-46"><a href="#cb69-46" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=FALSE, purl=FALSE}</span></span>
<span id="cb69-47"><a href="#cb69-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-48"><a href="#cb69-48" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"codigos/mallas.RData"</span>)</span>
<span id="cb69-49"><a href="#cb69-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-50"><a href="#cb69-50" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-51"><a href="#cb69-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-52"><a href="#cb69-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-53"><a href="#cb69-53" aria-hidden="true" tabindex="-1"></a><span class="fu">## Manejo de datos espaciales</span></span>
<span id="cb69-54"><a href="#cb69-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-55"><a href="#cb69-55" aria-hidden="true" tabindex="-1"></a>Mediante la función <span class="in">`read.table()`</span> se lee un archivo de texto que se guarda como un objeto denominado <span class="in">`suelos`</span>, en el cual las columnas están separadas por tabuladores y la primera fila contiene los nombres de columnas. Mediante la función <span class="in">`head()`</span> se visualizan las primeras filas del objeto <span class="in">`suelos`</span> donde se observa que la primera columna corresponde a una identificación, las siguientes dos son las coordenadas X e Y las cuales corresponden al sistema de proyección UTM faja 20. Las columnas siguientes contienen las variables en estudio.</span>
<span id="cb69-56"><a href="#cb69-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-57"><a href="#cb69-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-60"><a href="#cb69-60" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-61"><a href="#cb69-61" aria-hidden="true" tabindex="-1"></a>suelos <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">"datos/suelos_cba.txt"</span>,</span>
<span id="cb69-62"><a href="#cb69-62" aria-hidden="true" tabindex="-1"></a>                     <span class="at">sep =</span> <span class="st">"</span><span class="sc">\t</span><span class="st">"</span>, <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb69-63"><a href="#cb69-63" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(suelos)</span>
<span id="cb69-64"><a href="#cb69-64" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-65"><a href="#cb69-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-66"><a href="#cb69-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-67"><a href="#cb69-67" aria-hidden="true" tabindex="-1"></a>Para transformar este objeto en uno de clase espacial, se utilizará la función <span class="in">`st_as_sf()`</span>, especificando que las coordenadas X e Y, se encuentra en las columnas "X" e "Y", respectivamente. Todos los sistemas de coordenadas tienen asociados un código que los identifica y que a través del cual, se pueden conocer los parámetros asociados al mismo, este código se llama EPSG por su acrónimo en inglés. El código EPSG del sistema de referencia y proyección de la base de datos es 32720. El objeto <span class="in">`suelos_sf`</span>, ahora es un objeto espacial de clase <span class="in">`sf`</span>, donde cada observación corresponde a cada sitio de muestreo. Se muestra el sistema de referencia y proyección de las coordenadas y el tipo de geometría.</span>
<span id="cb69-68"><a href="#cb69-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-69"><a href="#cb69-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-72"><a href="#cb69-72" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-73"><a href="#cb69-73" aria-hidden="true" tabindex="-1"></a>suelos_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(suelos, </span>
<span id="cb69-74"><a href="#cb69-74" aria-hidden="true" tabindex="-1"></a>                      <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"X"</span>, <span class="st">"Y"</span>), </span>
<span id="cb69-75"><a href="#cb69-75" aria-hidden="true" tabindex="-1"></a>                      <span class="at">crs =</span> <span class="dv">32720</span>)</span>
<span id="cb69-76"><a href="#cb69-76" aria-hidden="true" tabindex="-1"></a>suelos_sf</span>
<span id="cb69-77"><a href="#cb69-77" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-78"><a href="#cb69-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-79"><a href="#cb69-79" aria-hidden="true" tabindex="-1"></a>Para explorar los datos se usa el paquete <span class="in">`tmap`</span> que permite realizar gráficos estáticos o dinámicos. Con la opción dinámica, se puede interactuar con el gráfico de manera análoga a un SIG. Para cada gráfico, se comienza utilizando la función <span class="in">`tm_shape()`</span> especificando el objeto a graficar. Cada observación se grafica un punto mediante la función <span class="in">`tm_dots()`</span>, cada nivel se agrega mediante el símbolo <span class="in">`+`</span>.</span>
<span id="cb69-80"><a href="#cb69-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-83"><a href="#cb69-83" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-84"><a href="#cb69-84" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(suelos_sf) <span class="sc">+</span> </span>
<span id="cb69-85"><a href="#cb69-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_dots</span>()</span>
<span id="cb69-86"><a href="#cb69-86" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-87"><a href="#cb69-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-88"><a href="#cb69-88" aria-hidden="true" tabindex="-1"></a>Para agregar latitud y longitud a esta figura se realiza una reproyección. En la función <span class="in">`tm_shape()`</span> se especifica el nuevo sistema de coordenadas con el que se desea graficar (argumento <span class="in">`projection`</span>). Se agregar el nivel <span class="in">`tm_grid()`</span> para visualizar una grilla que contiene las coordenadas latitud y longitud. </span>
<span id="cb69-89"><a href="#cb69-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-92"><a href="#cb69-92" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-93"><a href="#cb69-93" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(suelos_sf, <span class="at">projection =</span> <span class="dv">4326</span>) <span class="sc">+</span></span>
<span id="cb69-94"><a href="#cb69-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_grid</span>(<span class="at">col =</span> <span class="st">"grey90"</span>) <span class="sc">+</span></span>
<span id="cb69-95"><a href="#cb69-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_dots</span>()</span>
<span id="cb69-96"><a href="#cb69-96" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-97"><a href="#cb69-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-98"><a href="#cb69-98" aria-hidden="true" tabindex="-1"></a>Cualquiera de estos gráficos se puede convertir en un gráfico dinámico mediante la función <span class="in">`tmap_mode()`</span> especificando como argumento <span class="in">`"view"`</span>. Para continuar con gráficos estáticos se debe especificar <span class="in">`"plot"`</span> como argumento de esta función. Mediante la función <span class="in">`tm_basemap()`</span>, se pueden incorporar distintas capas base. Las opciones disponibles para las capas base se pueden ver mediante el comando <span class="in">`names(leaflet::providers)`</span>. </span>
<span id="cb69-99"><a href="#cb69-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-100"><a href="#cb69-100" aria-hidden="true" tabindex="-1"></a>Cualquiera de estos gráficos se puede convertir en un gráfico dinámico utilizando la función <span class="in">`tmap_mode()`</span> especificando como argumento <span class="in">`"view"`</span>. Para continuar con gráficos estáticos se debe especificar <span class="in">`"plot"`</span> como argumento de esta función. Mediante la función <span class="in">`tm_basemap()`</span>, se pueden incorporar distintas capas base (capas de fondo que ayudan a visualizar). Las opciones disponibles para las capas base se pueden ver mediante el comando <span class="in">`names(leaflet::providers)`</span>.</span>
<span id="cb69-101"><a href="#cb69-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-102"><a href="#cb69-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-103"><a href="#cb69-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-104"><a href="#cb69-104" aria-hidden="true" tabindex="-1"></a><span class="in">```{r suelossftmap, eval=FALSE}</span></span>
<span id="cb69-105"><a href="#cb69-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-106"><a href="#cb69-106" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_mode</span>(<span class="st">"view"</span>)</span>
<span id="cb69-107"><a href="#cb69-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-108"><a href="#cb69-108" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(suelos_sf) <span class="sc">+</span></span>
<span id="cb69-109"><a href="#cb69-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_dots</span>() <span class="sc">+</span></span>
<span id="cb69-110"><a href="#cb69-110" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_basemap</span>(<span class="st">"Esri.WorldImagery"</span>, <span class="st">"OpenTopoMap"</span>)</span>
<span id="cb69-111"><a href="#cb69-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-112"><a href="#cb69-112" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-113"><a href="#cb69-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-114"><a href="#cb69-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-115"><a href="#cb69-115" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo = FALSE, purl=FALSE}</span></span>
<span id="cb69-116"><a href="#cb69-116" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"figuras/suelossftmap.png"</span>)</span>
<span id="cb69-117"><a href="#cb69-117" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-118"><a href="#cb69-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-119"><a href="#cb69-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-120"><a href="#cb69-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-121"><a href="#cb69-121" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=FALSE, message=FALSE, eval=FALSE}</span></span>
<span id="cb69-122"><a href="#cb69-122" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_mode</span>(<span class="st">"plot"</span>)</span>
<span id="cb69-123"><a href="#cb69-123" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-124"><a href="#cb69-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-125"><a href="#cb69-125" aria-hidden="true" tabindex="-1"></a><span class="fu">## Confección de grillas de predicción</span></span>
<span id="cb69-126"><a href="#cb69-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-127"><a href="#cb69-127" aria-hidden="true" tabindex="-1"></a>Para generar esta grilla es necesario definir una resolución espacial en el área de interés. Para este ejemplo, se utiliza un archivo vectorial, **limites_cba.shp**, el cual define el límite del territorio sobre el que se desea predecir.</span>
<span id="cb69-128"><a href="#cb69-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-129"><a href="#cb69-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-130"><a href="#cb69-130" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE}</span></span>
<span id="cb69-131"><a href="#cb69-131" aria-hidden="true" tabindex="-1"></a>limites_cba <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"datos/limites_cba.shp"</span>,</span>
<span id="cb69-132"><a href="#cb69-132" aria-hidden="true" tabindex="-1"></a>                       <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb69-133"><a href="#cb69-133" aria-hidden="true" tabindex="-1"></a>limites_cba <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(limites_cba, </span>
<span id="cb69-134"><a href="#cb69-134" aria-hidden="true" tabindex="-1"></a>                            <span class="at">crs =</span> <span class="dv">32720</span>)</span>
<span id="cb69-135"><a href="#cb69-135" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-136"><a href="#cb69-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-137"><a href="#cb69-137" aria-hidden="true" tabindex="-1"></a>La función <span class="in">`st_make_grid()`</span> genera una grilla rectangular conteniendo el área del objeto <span class="in">`limites_cba`</span>. Para definir la resolución espacial de la grilla se utiliza el argumento <span class="in">`cellsize`</span> definiendo un tamaño de grilla en relación con la unidad de medida del sistema de coordenadas, en este caso 10000 metros, dado que está en UTM.</span>
<span id="cb69-138"><a href="#cb69-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-141"><a href="#cb69-141" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-142"><a href="#cb69-142" aria-hidden="true" tabindex="-1"></a>grilla_base <span class="ot">&lt;-</span> <span class="fu">st_make_grid</span>(limites_cba, </span>
<span id="cb69-143"><a href="#cb69-143" aria-hidden="true" tabindex="-1"></a>                            <span class="at">cellsize =</span> <span class="dv">10000</span>)</span>
<span id="cb69-144"><a href="#cb69-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-145"><a href="#cb69-145" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(grilla_base) <span class="sc">+</span></span>
<span id="cb69-146"><a href="#cb69-146" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>() <span class="sc">+</span></span>
<span id="cb69-147"><a href="#cb69-147" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(limites_cba) <span class="sc">+</span></span>
<span id="cb69-148"><a href="#cb69-148" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>(<span class="at">col =</span> <span class="st">"red"</span>)</span>
<span id="cb69-149"><a href="#cb69-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-150"><a href="#cb69-150" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-151"><a href="#cb69-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-152"><a href="#cb69-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-153"><a href="#cb69-153" aria-hidden="true" tabindex="-1"></a>Dado que la grilla es rectangular, es necesario cortarla según los límites. Para esto se realiza una intersección entre los límites y la grilla utilizando la función <span class="in">`st_intersection()`</span>.</span>
<span id="cb69-154"><a href="#cb69-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-155"><a href="#cb69-155" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, warning=FALSE}</span></span>
<span id="cb69-156"><a href="#cb69-156" aria-hidden="true" tabindex="-1"></a>grilla_pred <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(limites_cba,</span>
<span id="cb69-157"><a href="#cb69-157" aria-hidden="true" tabindex="-1"></a>                               grilla_base)</span>
<span id="cb69-158"><a href="#cb69-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-159"><a href="#cb69-159" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(grilla_pred) <span class="sc">+</span></span>
<span id="cb69-160"><a href="#cb69-160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>()</span>
<span id="cb69-161"><a href="#cb69-161" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-162"><a href="#cb69-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-163"><a href="#cb69-163" aria-hidden="true" tabindex="-1"></a>Los algoritmos de predicción implementados trabajan prediciendo sitios puntuales, por lo cual, a partir de la grilla, es necesario generar una grilla de puntos. Una alternativa es utilizar la función <span class="in">`st_centroid()`</span> para obtener el centroide de cada celda.</span>
<span id="cb69-164"><a href="#cb69-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-167"><a href="#cb69-167" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-168"><a href="#cb69-168" aria-hidden="true" tabindex="-1"></a>centroide_pred <span class="ot">&lt;-</span> <span class="fu">st_centroid</span>(grilla_pred)</span>
<span id="cb69-169"><a href="#cb69-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-170"><a href="#cb69-170" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(centroide_pred) <span class="sc">+</span></span>
<span id="cb69-171"><a href="#cb69-171" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_dots</span>()</span>
<span id="cb69-172"><a href="#cb69-172" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-173"><a href="#cb69-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-174"><a href="#cb69-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-175"><a href="#cb69-175" aria-hidden="true" tabindex="-1"></a><span class="fu">## Agregado de capas de información</span></span>
<span id="cb69-176"><a href="#cb69-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-177"><a href="#cb69-177" aria-hidden="true" tabindex="-1"></a>Se presenta los comandos necesarios para combinar múltiples capas de información en un mismo objeto. Las variables elevación y twi son extraídas desde modelos digitales de elevación, que se encuentran en formato raster. El paquete <span class="in">`terra`</span> de R es específico para lectura y manipulación de este tipo de archivos. Para leer un archivo de este formato, se puede utilizar la función <span class="in">`rast()`</span> mientras que para reproyectar se utiliza la función <span class="in">`project()`</span>. El archivo **elevacion.tif** contiene datos de elevación para la provincia de Córdoba. Cuando se imprime el objeto, se muestra la cantidad de pixeles por fila, columna, pixeles totales, la resolución espacial, las coordenadas extremas en latitud y longitud, el sistema de coordenadas de referencia, los valores mínimo y máximo de la variable observada.</span>
<span id="cb69-178"><a href="#cb69-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-181"><a href="#cb69-181" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-182"><a href="#cb69-182" aria-hidden="true" tabindex="-1"></a>elevacion <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">"datos/elevacion.tif"</span>)</span>
<span id="cb69-183"><a href="#cb69-183" aria-hidden="true" tabindex="-1"></a>elevacion <span class="ot">&lt;-</span></span>
<span id="cb69-184"><a href="#cb69-184" aria-hidden="true" tabindex="-1"></a>  <span class="fu">project</span>(elevacion, </span>
<span id="cb69-185"><a href="#cb69-185" aria-hidden="true" tabindex="-1"></a>          <span class="at">y =</span> <span class="st">"+proj=utm +zone=20 +south </span></span>
<span id="cb69-186"><a href="#cb69-186" aria-hidden="true" tabindex="-1"></a><span class="st">                +datum=WGS84 +units=m +no_defs"</span>)</span>
<span id="cb69-187"><a href="#cb69-187" aria-hidden="true" tabindex="-1"></a>elevacion</span>
<span id="cb69-188"><a href="#cb69-188" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-189"><a href="#cb69-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-190"><a href="#cb69-190" aria-hidden="true" tabindex="-1"></a>Para obtener en los sitios de predicción el valor de la variable del objeto raster, se utiliza la función <span class="in">`extract()`</span> definiendo como argumento el nombre del objeto raster y el nombre del objeto vectorial que contiene los sitios. Estos valores extraídos se adicionan en una columna llamada <span class="in">`elevacion`</span> dentro del objeto <span class="in">`centroide_pred`</span> utilizando la funcion <span class="in">`cbind`</span>.</span>
<span id="cb69-191"><a href="#cb69-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-194"><a href="#cb69-194" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-195"><a href="#cb69-195" aria-hidden="true" tabindex="-1"></a>elevacion_val <span class="ot">&lt;-</span></span>
<span id="cb69-196"><a href="#cb69-196" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract</span>(elevacion, centroide_pred, <span class="at">ID =</span> <span class="cn">FALSE</span>)</span>
<span id="cb69-197"><a href="#cb69-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-198"><a href="#cb69-198" aria-hidden="true" tabindex="-1"></a>centroide_pred <span class="ot">&lt;-</span> </span>
<span id="cb69-199"><a href="#cb69-199" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(centroide_pred,</span>
<span id="cb69-200"><a href="#cb69-200" aria-hidden="true" tabindex="-1"></a>        elevacion_val)</span>
<span id="cb69-201"><a href="#cb69-201" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-202"><a href="#cb69-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-203"><a href="#cb69-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-204"><a href="#cb69-204" aria-hidden="true" tabindex="-1"></a>El archivo **twi.tif** contiene valores de un índice topográfico de humedad también generado a partir de datos provenientes de un modelo digital de elevación.. </span>
<span id="cb69-205"><a href="#cb69-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-208"><a href="#cb69-208" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-209"><a href="#cb69-209" aria-hidden="true" tabindex="-1"></a>twi <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">"datos/twi.tif"</span>)</span>
<span id="cb69-210"><a href="#cb69-210" aria-hidden="true" tabindex="-1"></a>twi <span class="ot">&lt;-</span></span>
<span id="cb69-211"><a href="#cb69-211" aria-hidden="true" tabindex="-1"></a>  <span class="fu">project</span>(twi, </span>
<span id="cb69-212"><a href="#cb69-212" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"+proj=utm +zone=20 +south</span></span>
<span id="cb69-213"><a href="#cb69-213" aria-hidden="true" tabindex="-1"></a><span class="st">                +datum=WGS84 +units=m +no_defs"</span>)</span>
<span id="cb69-214"><a href="#cb69-214" aria-hidden="true" tabindex="-1"></a>twi</span>
<span id="cb69-215"><a href="#cb69-215" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-216"><a href="#cb69-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-217"><a href="#cb69-217" aria-hidden="true" tabindex="-1"></a>Utilizando la función <span class="in">`extract()`</span> se extrae los valores de TWI para cada sitio de la grilla de predicción.</span>
<span id="cb69-218"><a href="#cb69-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-221"><a href="#cb69-221" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-222"><a href="#cb69-222" aria-hidden="true" tabindex="-1"></a>twi_val <span class="ot">&lt;-</span> <span class="fu">extract</span>(twi, centroide_pred, <span class="at">ID =</span> <span class="cn">FALSE</span>)</span>
<span id="cb69-223"><a href="#cb69-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-224"><a href="#cb69-224" aria-hidden="true" tabindex="-1"></a>centroide_pred <span class="ot">&lt;-</span></span>
<span id="cb69-225"><a href="#cb69-225" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(centroide_pred,</span>
<span id="cb69-226"><a href="#cb69-226" aria-hidden="true" tabindex="-1"></a>        twi_val)</span>
<span id="cb69-227"><a href="#cb69-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-228"><a href="#cb69-228" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-229"><a href="#cb69-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-230"><a href="#cb69-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-231"><a href="#cb69-231" aria-hidden="true" tabindex="-1"></a>Se adiciona a la grilla variables procedentes de otras fuentes (SIG de muestreo de suelo). Estos datos se encuentran en los archivos raster llamados **arcilla.tif** y **pH.tif**, respectivamente. Estos raster tienen la misma resolución espacial y extensión, por lo que es posible superponerlos en un mismo objeto mediante la función <span class="in">`c()`</span>.</span>
<span id="cb69-232"><a href="#cb69-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-235"><a href="#cb69-235" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-236"><a href="#cb69-236" aria-hidden="true" tabindex="-1"></a>arcilla <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">"datos/arcilla.tif"</span>)</span>
<span id="cb69-237"><a href="#cb69-237" aria-hidden="true" tabindex="-1"></a>pH <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">"datos/pH.tif"</span>)</span>
<span id="cb69-238"><a href="#cb69-238" aria-hidden="true" tabindex="-1"></a>edaf <span class="ot">&lt;-</span> <span class="fu">c</span>(pH, arcilla)</span>
<span id="cb69-239"><a href="#cb69-239" aria-hidden="true" tabindex="-1"></a><span class="fu">crs</span>(edaf) <span class="ot">&lt;-</span> <span class="st">"+proj=utm +zone=20 +south +datum=WGS84 +units=m +no_defs"</span></span>
<span id="cb69-240"><a href="#cb69-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-241"><a href="#cb69-241" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(edaf) <span class="sc">+</span></span>
<span id="cb69-242"><a href="#cb69-242" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_raster</span>() <span class="sc">+</span></span>
<span id="cb69-243"><a href="#cb69-243" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_facets</span>(<span class="at">free.scales =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb69-244"><a href="#cb69-244" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_legend</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">'left'</span>,<span class="st">'bottom'</span>))</span>
<span id="cb69-245"><a href="#cb69-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-246"><a href="#cb69-246" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-247"><a href="#cb69-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-248"><a href="#cb69-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-249"><a href="#cb69-249" aria-hidden="true" tabindex="-1"></a>Se seleccionan los valores de los sitios utilizando la función <span class="in">`extract()`</span>. Como los valores extraídos mediante la funcion desde un *stack* de rasters genera un objeto de tipo <span class="in">`data.frame`</span> con tantas columnas como capas contenga ese raster, se adicionan al objeto <span class="in">`centroide_pred`</span> mediante la función <span class="in">`cbind()`</span>, la cual une columnas de igual número de filas. Ahora el objeto <span class="in">`cetroide_pred`</span> contiene todos los sitios de predicción con las variables auxiliares adicionadas.</span>
<span id="cb69-250"><a href="#cb69-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-253"><a href="#cb69-253" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-254"><a href="#cb69-254" aria-hidden="true" tabindex="-1"></a>edaf_pred <span class="ot">&lt;-</span> <span class="fu">extract</span>(edaf, </span>
<span id="cb69-255"><a href="#cb69-255" aria-hidden="true" tabindex="-1"></a>                     centroide_pred, </span>
<span id="cb69-256"><a href="#cb69-256" aria-hidden="true" tabindex="-1"></a>                     <span class="at">ID =</span> <span class="cn">FALSE</span>)</span>
<span id="cb69-257"><a href="#cb69-257" aria-hidden="true" tabindex="-1"></a>centroide_pred <span class="ot">&lt;-</span> <span class="fu">cbind</span>(centroide_pred, </span>
<span id="cb69-258"><a href="#cb69-258" aria-hidden="true" tabindex="-1"></a>                        edaf_pred)</span>
<span id="cb69-259"><a href="#cb69-259" aria-hidden="true" tabindex="-1"></a>centroide_pred</span>
<span id="cb69-260"><a href="#cb69-260" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-261"><a href="#cb69-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-262"><a href="#cb69-262" aria-hidden="true" tabindex="-1"></a>Para identificar la variación de la variable de interés en un plano, se puede usar una escala de colores. La elección de la escala cambia según los colores y los puntos de corte (valores de la variable de interés en los cuales cambia el color). Para definirla algunas opciones automáticamente identifican los valores para categorizar y asignar un color. Por defecto, <span class="in">`tmap`</span> categoriza los valores en intervalos fijos. Utilizando el argumento <span class="in">`style`</span>, se puede modificar el método a utilizar. Las opciones <span class="in">`style = "order"`</span> y <span class="in">`style = "cont"`</span> permiten representar variables numéricas en un gradiente de color. La opción "order" realiza una escala en función del ranking de los valores, permitiendo una mejor visualización de variables asimétricas. Para la visualización de más de un mapa generado con <span class="in">`tmap`</span> en un mismo gráfico, se puede utilizar la función <span class="in">`tmap_arrange()`</span>, utilizando como argumento los mapas que se quieren visualizar. El argumento <span class="in">`sync = TRUE`</span> permite la visualización interactiva con la navegación (zoom y movimiento) sincronizada en ambos mapas. </span>
<span id="cb69-263"><a href="#cb69-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-264"><a href="#cb69-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-267"><a href="#cb69-267" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-268"><a href="#cb69-268" aria-hidden="true" tabindex="-1"></a>elevTm <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(centroide_pred) <span class="sc">+</span></span>
<span id="cb69-269"><a href="#cb69-269" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_dots</span>(<span class="st">"elevacion"</span>, <span class="at">style =</span> <span class="st">"order"</span>)</span>
<span id="cb69-270"><a href="#cb69-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-271"><a href="#cb69-271" aria-hidden="true" tabindex="-1"></a>twiTm <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(centroide_pred) <span class="sc">+</span></span>
<span id="cb69-272"><a href="#cb69-272" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_dots</span>(<span class="st">"twi"</span>, <span class="at">style =</span> <span class="st">"cont"</span>)</span>
<span id="cb69-273"><a href="#cb69-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-274"><a href="#cb69-274" aria-hidden="true" tabindex="-1"></a>pHTM <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(centroide_pred) <span class="sc">+</span></span>
<span id="cb69-275"><a href="#cb69-275" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_dots</span>(<span class="st">"pH"</span>, <span class="at">style =</span> <span class="st">"cont"</span>)</span>
<span id="cb69-276"><a href="#cb69-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-277"><a href="#cb69-277" aria-hidden="true" tabindex="-1"></a>arcillaTm <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(centroide_pred) <span class="sc">+</span></span>
<span id="cb69-278"><a href="#cb69-278" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_dots</span>(<span class="st">"arcilla"</span>, <span class="at">style =</span> <span class="st">"cont"</span>)</span>
<span id="cb69-279"><a href="#cb69-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-280"><a href="#cb69-280" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_arrange</span>(elevTm, twiTm, pHTM, arcillaTm, </span>
<span id="cb69-281"><a href="#cb69-281" aria-hidden="true" tabindex="-1"></a>             <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb69-282"><a href="#cb69-282" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-283"><a href="#cb69-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-284"><a href="#cb69-284" aria-hidden="true" tabindex="-1"></a><span class="fu"># Predicción con múltiples capas de datos</span></span>
<span id="cb69-285"><a href="#cb69-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-286"><a href="#cb69-286" aria-hidden="true" tabindex="-1"></a>Una vez que se ha confeccionado la grilla de predicción y se ha unificado el sistema de referencia espacial entre las distintas capas de información, se comienza con el ajuste de modelos que luego serán usados para la predicción espacial en sitios sin datos. El objeto <span class="in">`suelos`</span>, se utilizará para el ajuste de los modelos predictivos, mientras que <span class="in">`cetroide_pred`</span> se usará para obtener predicciones para cada celda de la grilla.</span>
<span id="cb69-287"><a href="#cb69-287" aria-hidden="true" tabindex="-1"></a>La distribución espacial de la variable de interés (COS) puede visualizarse con funciones del paquete <span class="in">`tmap.`</span> A través del argumento <span class="in">`palette`</span> se modifica la paleta de colores, las opciones disponibles pueden buscarse ejecutando el comando <span class="in">`tmaptools::palette_explorer()`</span>. También se pueden adicionar otras herramientas de estadística descriptiva, como por ejemplo un histograma de frecuencia mediante el argumento <span class="in">`legend.hist = TRUE`</span>. Los estilos de los ejes y leyendas se pueden modificar con la función <span class="in">`tm_layout()`</span>.</span>
<span id="cb69-288"><a href="#cb69-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-291"><a href="#cb69-291" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-292"><a href="#cb69-292" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(suelos_sf) <span class="sc">+</span></span>
<span id="cb69-293"><a href="#cb69-293" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_dots</span>(</span>
<span id="cb69-294"><a href="#cb69-294" aria-hidden="true" tabindex="-1"></a>    <span class="st">"COS"</span>,</span>
<span id="cb69-295"><a href="#cb69-295" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="st">"quantile"</span>,</span>
<span id="cb69-296"><a href="#cb69-296" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">0.5</span>,</span>
<span id="cb69-297"><a href="#cb69-297" aria-hidden="true" tabindex="-1"></a>    <span class="at">palette =</span> <span class="st">"BuGn"</span>,</span>
<span id="cb69-298"><a href="#cb69-298" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.hist =</span> <span class="cn">TRUE</span></span>
<span id="cb69-299"><a href="#cb69-299" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb69-300"><a href="#cb69-300" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(</span>
<span id="cb69-301"><a href="#cb69-301" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.format =</span> <span class="fu">list</span>(<span class="at">text.separator =</span> <span class="st">" a "</span>),</span>
<span id="cb69-302"><a href="#cb69-302" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.outside =</span> <span class="cn">TRUE</span>,</span>
<span id="cb69-303"><a href="#cb69-303" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.hist.width =</span> <span class="dv">1</span></span>
<span id="cb69-304"><a href="#cb69-304" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb69-305"><a href="#cb69-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-306"><a href="#cb69-306" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-307"><a href="#cb69-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-308"><a href="#cb69-308" aria-hidden="true" tabindex="-1"></a><span class="fu">## Regresión con errores correlacionados espacialmente vía REML</span></span>
<span id="cb69-309"><a href="#cb69-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-310"><a href="#cb69-310" aria-hidden="true" tabindex="-1"></a>Se ajusta un modelo de regresión lineal con la función <span class="in">`gls()`</span>, usando COS como variable dependiente y elevación, twi, arcilla y pH como variables predictoras.  Primero, se ajusta suponiendo errores independientes (sin correlación espacial). Los resultados se guardan en el objeto denominado <span class="in">`ajuste_ML`</span>. Seguidamente, se ajusta otro modelo de regresión con igual estructura para la componente sistemática, pero suponiendo que los términos de error aleatorio no son independientes sino que se correlacionan a través de un modelo de covarianza espacial. En particular, se ajusta el modelo de correlación espacial esférico y se suponen varianza residual única (modelo homocedástico). El método de estimación del modelo es REML. Los resultados se guardan en el objeto <span class="in">`ajuste_err_corr`</span>.</span>
<span id="cb69-311"><a href="#cb69-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-312"><a href="#cb69-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-315"><a href="#cb69-315" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-316"><a href="#cb69-316" aria-hidden="true" tabindex="-1"></a>ajuste_ML <span class="ot">&lt;-</span> <span class="fu">gls</span>(</span>
<span id="cb69-317"><a href="#cb69-317" aria-hidden="true" tabindex="-1"></a>  COS <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> elevacion <span class="sc">+</span> twi <span class="sc">+</span> arcilla <span class="sc">+</span> pH,</span>
<span id="cb69-318"><a href="#cb69-318" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> suelos,</span>
<span id="cb69-319"><a href="#cb69-319" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"REML"</span>)</span>
<span id="cb69-320"><a href="#cb69-320" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-321"><a href="#cb69-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-322"><a href="#cb69-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-325"><a href="#cb69-325" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-326"><a href="#cb69-326" aria-hidden="true" tabindex="-1"></a>ajuste_err_corr <span class="ot">&lt;-</span> <span class="fu">gls</span>(</span>
<span id="cb69-327"><a href="#cb69-327" aria-hidden="true" tabindex="-1"></a>  COS <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> elevacion <span class="sc">+</span> twi <span class="sc">+</span> arcilla <span class="sc">+</span> pH,</span>
<span id="cb69-328"><a href="#cb69-328" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> suelos,</span>
<span id="cb69-329"><a href="#cb69-329" aria-hidden="true" tabindex="-1"></a>  <span class="at">correlation =</span> <span class="fu">corSpher</span>(<span class="at">form =</span>  <span class="sc">~</span> X <span class="sc">+</span> Y),</span>
<span id="cb69-330"><a href="#cb69-330" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"REML"</span></span>
<span id="cb69-331"><a href="#cb69-331" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-332"><a href="#cb69-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-333"><a href="#cb69-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-334"><a href="#cb69-334" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-335"><a href="#cb69-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-336"><a href="#cb69-336" aria-hidden="true" tabindex="-1"></a>Utilizando la función <span class="in">`summary()`</span> se muestra a continuación el resultado del modelo sin correlación espacial (<span class="in">`objeto ajuste_ML`</span>). Todos los términos del modelo, a excepción de elevacion resultaron significativos para un nivel de significación $\alpha=0.05$. Se observó una correlación alta entre elevacion y twi (0,859), por esta colinealidad entre ambas variables, el término elevacion pudo no haber resultado significativo y podría sacarse del modelo. Se muestra también las características de la distribución de los residuos (mínimo, máximo valor y principales cuartiles). Es de esperar que los residuos estandarizados se encuentren en el intervalo <span class="co">[</span><span class="ot">-3, 3</span><span class="co">]</span>, los valores fuera de este rango se consideran valores atípicos y podrían ser eliminados para reajustar el modelo. La varianza residual es el cuadrado de 4.58, indicando que desviaciones de 4,58 g\/kg pueden existir por azar y que no se relacionan a las fuentes de variación reconocidas a priori.</span>
<span id="cb69-337"><a href="#cb69-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-340"><a href="#cb69-340" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-341"><a href="#cb69-341" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ajuste_ML)</span>
<span id="cb69-342"><a href="#cb69-342" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-343"><a href="#cb69-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-344"><a href="#cb69-344" aria-hidden="true" tabindex="-1"></a>Para el modelo ajustado suponiendo errores correlacionados, los criterios de información de AIC y BIC fueron menores que los obtenidos bajo el supuesto de errores independientes, indicando la conveniencia de considerar la correlación espacial. Los parámetros del modelo asociado a la componente aleatoria son rango = 17791,35 m y varianza residual igual al cuadrado de 4,56. Estos caracterizan la matriz de varianza y covarianza de los errores y proveen una estimación del semivariograma esférico que describe el proceso espacial subyacente, *i.e.* observaciones separadas por más de 17791,35 m no se encuentran correlacionadas y la varianza residual de las observaciones independientes o con distancias mayor al rango, expresada como desvío estándar, es 4,56.</span>
<span id="cb69-345"><a href="#cb69-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-348"><a href="#cb69-348" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-349"><a href="#cb69-349" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ajuste_err_corr)</span>
<span id="cb69-350"><a href="#cb69-350" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-351"><a href="#cb69-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-352"><a href="#cb69-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-353"><a href="#cb69-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-354"><a href="#cb69-354" aria-hidden="true" tabindex="-1"></a>Las predicciones se realizaron utilizando la función <span class="in">`predict()`</span> sobre los centroides de la grilla de predicción utilizando el mejor modelo entre los ajustados.  Se convierte el objeto <span class="in">`centroide_pred`</span> en un <span class="in">`data.frame`</span>, eliminando del objeto <span class="in">`centroide_pred`</span> la columna que contiene las características espaciales mediante la función <span class="in">`st_drop_geometry()`</span> y extrayendo mediante la función <span class="in">`st_coordinates()`</span>, las coordenadas sin los atributos espaciales. Estas partes se guardan en el objeto <span class="in">`suelos_pred`</span> de clase <span class="in">`data.frame`</span>.</span>
<span id="cb69-355"><a href="#cb69-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-358"><a href="#cb69-358" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-359"><a href="#cb69-359" aria-hidden="true" tabindex="-1"></a>suelos_pred <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb69-360"><a href="#cb69-360" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>(centroide_pred),</span>
<span id="cb69-361"><a href="#cb69-361" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_coordinates</span>(centroide_pred))</span>
<span id="cb69-362"><a href="#cb69-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-363"><a href="#cb69-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-364"><a href="#cb69-364" aria-hidden="true" tabindex="-1"></a>pred_ajuste_err_corr <span class="ot">&lt;-</span> <span class="fu">predict</span>(</span>
<span id="cb69-365"><a href="#cb69-365" aria-hidden="true" tabindex="-1"></a>  ajuste_err_corr,</span>
<span id="cb69-366"><a href="#cb69-366" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> suelos_pred,</span>
<span id="cb69-367"><a href="#cb69-367" aria-hidden="true" tabindex="-1"></a>  <span class="at">na.action =</span> na.pass)</span>
<span id="cb69-368"><a href="#cb69-368" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-369"><a href="#cb69-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-370"><a href="#cb69-370" aria-hidden="true" tabindex="-1"></a>Los predichos se adicionan al objeto <span class="in">`centroide_pred`</span> utilizando la función <span class="in">`cbind()`</span>. Para que la visualización de estos valores, se pueda realizar utilizando los polígonos de la grilla de predicción en vez de los centroides, se deben adicionar los predichos mediante la función <span class="in">`st_join()`</span>.</span>
<span id="cb69-371"><a href="#cb69-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-374"><a href="#cb69-374" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-375"><a href="#cb69-375" aria-hidden="true" tabindex="-1"></a>pred_err_corr <span class="ot">&lt;-</span> <span class="fu">cbind</span>(</span>
<span id="cb69-376"><a href="#cb69-376" aria-hidden="true" tabindex="-1"></a>  centroide_pred,</span>
<span id="cb69-377"><a href="#cb69-377" aria-hidden="true" tabindex="-1"></a>  <span class="st">"COS_pred"</span> <span class="ot">=</span> pred_ajuste_err_corr)</span>
<span id="cb69-378"><a href="#cb69-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-379"><a href="#cb69-379" aria-hidden="true" tabindex="-1"></a>pred_err_corr <span class="ot">&lt;-</span> <span class="fu">st_join</span>(</span>
<span id="cb69-380"><a href="#cb69-380" aria-hidden="true" tabindex="-1"></a>  grilla_pred,</span>
<span id="cb69-381"><a href="#cb69-381" aria-hidden="true" tabindex="-1"></a>  pred_err_corr)</span>
<span id="cb69-382"><a href="#cb69-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-383"><a href="#cb69-383" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(pred_err_corr) <span class="sc">+</span></span>
<span id="cb69-384"><a href="#cb69-384" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_fill</span>(<span class="st">"COS_pred"</span>, <span class="at">style =</span> <span class="st">"cont"</span>,</span>
<span id="cb69-385"><a href="#cb69-385" aria-hidden="true" tabindex="-1"></a>          <span class="at">title =</span> <span class="st">"Predichos COS (g/kg)"</span>)</span>
<span id="cb69-386"><a href="#cb69-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-387"><a href="#cb69-387" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-388"><a href="#cb69-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-389"><a href="#cb69-389" aria-hidden="true" tabindex="-1"></a><span class="fu">## Regresión con efectos aleatorios de sitio vía INLA</span></span>
<span id="cb69-390"><a href="#cb69-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-391"><a href="#cb69-391" aria-hidden="true" tabindex="-1"></a>Para abordar la regresión bayesiana de datos espaciales, primero se define el predictor lineal ajustando un modelo de regresión lineal con la función <span class="in">`inla()`</span>. INLA representa una combinación de aproximaciones analíticas y esquemas de integración numérica eficiente para obtener una aproximación confiable de la distribución a posteriori de interés. En el ejemplo de ilustración, se usa COS como variable dependiente y elevación, twi, arcilla y pH como variables predictoras y no se ha contemplado la estructura de correlación espacial. Se especifica la distribución que se asume para la variable respuesta a través del argumento <span class="in">`family`</span>. El cómputo de las medidas para evaluación y comparación de modelos se realiza con el argumento <span class="in">`control.compute`</span> especificando la medida que se pretende. Para explorar las opciones disponibles para la evaluación y comparación de modelos se ejecuta el comando <span class="in">`?control.compute`</span> (en el ejemplo, se solicita el criterio DIC).</span>
<span id="cb69-392"><a href="#cb69-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-395"><a href="#cb69-395" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-396"><a href="#cb69-396" aria-hidden="true" tabindex="-1"></a>ajuste_INLA <span class="ot">&lt;-</span> <span class="fu">inla</span>(</span>
<span id="cb69-397"><a href="#cb69-397" aria-hidden="true" tabindex="-1"></a>  COS <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> elevacion <span class="sc">+</span> twi <span class="sc">+</span> arcilla <span class="sc">+</span> pH,</span>
<span id="cb69-398"><a href="#cb69-398" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="st">'gaussian'</span>,</span>
<span id="cb69-399"><a href="#cb69-399" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> suelos,</span>
<span id="cb69-400"><a href="#cb69-400" aria-hidden="true" tabindex="-1"></a>  <span class="at">control.compute =</span> <span class="fu">list</span>(<span class="at">dic =</span> <span class="cn">TRUE</span>))</span>
<span id="cb69-401"><a href="#cb69-401" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-402"><a href="#cb69-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-403"><a href="#cb69-403" aria-hidden="true" tabindex="-1"></a>El modelo ajustado es retornado como un objeto INLA. Este provee información sobre el tiempo de procesado y algunos estadísticos sobre las distribuciones a posteriori de los coeficientes de regresión (efectos fijos) y de los hiperparámetros. Para el modelo ajustado se observan los intervalos de credibilidad del 95\% para los coeficientes de regresión asociados a cada una de las variables predictoras (predictor lineal) y como hiperparámetro la precisión de las observaciones de COS. En este ajuste, no hubo efectos aleatorios ni especificaciones relacionadas a la espacialidad de los datos.</span>
<span id="cb69-404"><a href="#cb69-404" aria-hidden="true" tabindex="-1"></a>El intervalo de credibilidad contiene al verdadero parámetro con un 95\% de probabilidad. Luego, el ajusta indica que todas las variables impactan a la respuesta, excepto la variable elevación para la cual el desvío estándar (sd) es alto relativo a la media de la distribución del coeficiente de regresión y el intervalo de credibilidad contiene al 0. Podría ser oportuno realizar un nuevo ajuste sin esta variable, que como se ha especificado anteriormente está altamente correlacionada con twi. La media a posteriori para el coeficiente de regresión que acompaña el pH es -0,766 con un intervalo de credibilidad del 95\% entre -1,515 y -0,018, por lo que se interpreta que a mayores valores de pH se tendrán menores valores de COS. Se muestra también el intervalo de credibilidad <span class="sc">\[</span>0,041; 0,055<span class="sc">\]</span> para la precisión (inversa de la varianza $1/\sigma_e^2$ ), la estimación es 0,048 y por tanto la varianza residual es próxima a 20 o el error estándar residual cercano a 4,56. El valor de DIC, el cual es una función de la deviance del modelo y de una medida del número efectivo de parámetros del modelo, es 2065,79. El numero efectivo de parámetros es una cantidad que caracteriza la complejidad del modelo y que no solo depende de la cantidad de parámetros sino también de la dependencia entre ellos. Esta medida puede ser usada para comparar modelos, menores valores indican mejor ajuste del modelo a los datos. El mejor de los modelos ajustados, también tendrá menor diferencia entre el valor de DIC para ese modelo y el valor de DIC para el modelo saturado. La verosimilitud marginal es otro criterio usado en selección de modelos en estadística bayesiana, al reportarse en escala log menor valor indica mejor ajuste. R-INLA obtiene las distribuciones marginales a posteriori para todos los parámetros del modelo.</span>
<span id="cb69-405"><a href="#cb69-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-406"><a href="#cb69-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-409"><a href="#cb69-409" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-410"><a href="#cb69-410" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ajuste_INLA)</span>
<span id="cb69-411"><a href="#cb69-411" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-412"><a href="#cb69-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-413"><a href="#cb69-413" aria-hidden="true" tabindex="-1"></a>Los efectos aleatorios en INLA se incluyen en la formula del predictor lineal usando la función <span class="in">`f()`</span>. Para el ejemplo de ilustración, más abajo se ajusta el modelo de regresión donde se adiciona un efecto aleatorio de sitio para caracterizar el proceso espacial subyacente a los datos. Dado que la función <span class="in">`f()`</span> se valúa sobre un red de nodos conformada a partir de las observaciones, es primero necesario construir una malla que cubra el dominio espacial y definir un objeto que contiene la identificación de los nodos con observaciones.  La malla se arma con la función <span class="in">`inla.mesh.2d()`</span> cuyos argumentos o parámetros de la malla son: <span class="in">`cutoff`</span> define la distancia mínima entre vértices de los triángulos que conforman la malla y <span class="in">`max.edge`</span> que refiere a la longitud máxima del lado de cada triángulo. Por defecto, la malla se construye con el método de triangulación de Delauny.</span>
<span id="cb69-414"><a href="#cb69-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-415"><a href="#cb69-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-416"><a href="#cb69-416" aria-hidden="true" tabindex="-1"></a><span class="in">```{r malla, eval=FALSE}</span></span>
<span id="cb69-417"><a href="#cb69-417" aria-hidden="true" tabindex="-1"></a>sitios <span class="ot">&lt;-</span> suelos[, <span class="fu">c</span>(<span class="st">"X"</span>, <span class="st">"Y"</span>)]</span>
<span id="cb69-418"><a href="#cb69-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-419"><a href="#cb69-419" aria-hidden="true" tabindex="-1"></a>malla <span class="ot">&lt;-</span> <span class="fu">inla.mesh.2d</span>(sitios, <span class="at">cutoff =</span> <span class="dv">200</span>,</span>
<span id="cb69-420"><a href="#cb69-420" aria-hidden="true" tabindex="-1"></a>                      <span class="at">max.edge =</span> <span class="dv">200000</span>)</span>
<span id="cb69-421"><a href="#cb69-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-422"><a href="#cb69-422" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-423"><a href="#cb69-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-424"><a href="#cb69-424" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, include=FALSE, echo=FALSE}</span></span>
<span id="cb69-425"><a href="#cb69-425" aria-hidden="true" tabindex="-1"></a><span class="co"># nodos &lt;- malla$idx$loc</span></span>
<span id="cb69-426"><a href="#cb69-426" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-427"><a href="#cb69-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-428"><a href="#cb69-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-429"><a href="#cb69-429" aria-hidden="true" tabindex="-1"></a>Para estimar la matriz de varianzas y covarianzas de los efectos de sitio por el método SPDE se utiliza la función <span class="in">`inla.spde2.matern()`</span>. Un argumento a especificar es el parámetro $\alpha$ (que varía entre 0 y 2). Por defecto es 2 para aproxima una función de correlación espacial del tipo exponencial como modelo de correlación espacial entre los efectos de sitio.</span>
<span id="cb69-430"><a href="#cb69-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-431"><a href="#cb69-431" aria-hidden="true" tabindex="-1"></a><span class="in">```{r creacspde}</span></span>
<span id="cb69-432"><a href="#cb69-432" aria-hidden="true" tabindex="-1"></a>spde <span class="ot">&lt;-</span> <span class="fu">inla.spde2.matern</span>(<span class="at">mesh =</span> malla,</span>
<span id="cb69-433"><a href="#cb69-433" aria-hidden="true" tabindex="-1"></a>                          <span class="at">alpha =</span> <span class="dv">2</span>)</span>
<span id="cb69-434"><a href="#cb69-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-435"><a href="#cb69-435" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-436"><a href="#cb69-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-437"><a href="#cb69-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-438"><a href="#cb69-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-439"><a href="#cb69-439" aria-hidden="true" tabindex="-1"></a>Otra función posible es <span class="in">`inla.spde2.pcmatern`</span>, en la cual hay que especificar el rango (argumetno <span class="in">`prior.range`</span>) y desvío estándar marginal (argumetno <span class="in">`prior.sigma`</span>) a priori. Para ambos argumentos hay que especificarle un vector de largo dos. En el caso de <span class="in">`prior.range`</span> los valores contienen el range0 y Prange, especificando que $P(\rho &lt; \rho_0) = p_\rho$, donde $\rho$ es el rando espacial del campo aleatorio. El argumento <span class="in">`prior.sigma`</span> se especifica de tal manera que $P(\sigma &gt; \sigma_0) = p_\rho$, donde $\sigma$ es la desviación estándar residual del campo.</span>
<span id="cb69-440"><a href="#cb69-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-441"><a href="#cb69-441" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- https://groups.google.com/g/r-inla-discussion-group/c/dunoXK_yAco --&gt;</span></span>
<span id="cb69-442"><a href="#cb69-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-443"><a href="#cb69-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-446"><a href="#cb69-446" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-447"><a href="#cb69-447" aria-hidden="true" tabindex="-1"></a>spde <span class="ot">&lt;-</span> <span class="fu">inla.spde2.pcmatern</span>(</span>
<span id="cb69-448"><a href="#cb69-448" aria-hidden="true" tabindex="-1"></a>  <span class="at">mesh =</span> malla,</span>
<span id="cb69-449"><a href="#cb69-449" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior.range =</span> <span class="fu">c</span>(<span class="dv">20000</span>, <span class="fl">0.05</span>),</span>
<span id="cb69-450"><a href="#cb69-450" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior.sigma =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.05</span>)</span>
<span id="cb69-451"><a href="#cb69-451" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-452"><a href="#cb69-452" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-453"><a href="#cb69-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-454"><a href="#cb69-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-455"><a href="#cb69-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-456"><a href="#cb69-456" aria-hidden="true" tabindex="-1"></a>Luego de realizar la malla y crear el objeto del modelo  Matern, se ajusta el modelo de regresión con efecto aleatorio de sitio. En esta ilustración se ajustará utilizando tanto la función <span class="in">`inla()`</span> del paquete <span class="in">`INLA`</span>, como así también la función <span class="in">`bru()`</span> del paquete <span class="in">`inlabru`</span>. Con ambas funciones se obtendrá el mismo modelo, por lo que se debería seleccionar una única alternativa. </span>
<span id="cb69-457"><a href="#cb69-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-458"><a href="#cb69-458" aria-hidden="true" tabindex="-1"></a>El paquete <span class="in">`inlabru`</span> fue desarrollado para facilitar la modelación espacial utilizando funciones del paquete <span class="in">`INLA`</span>, por lo que crearemos un objeto espacial llamado <span class="in">`suelos_sf`</span> para la función que pueda identificar los sitios y el sistema de coordenadas de manera automática. Los resultados son un objeto INLA que incluyen las distribuciones a posteriori de los efectos latentes y de los hiperparámetros, así como estadísticos de resumen. Como se ejemplifica adelante, pueden obtenerse estimaciones a posteriori de parámetros del campo espacial latente. La fórmula es similar a la especificada anteriormente, pero se adiciona el efecto de sitio llamado <span class="in">`site`</span>.</span>
<span id="cb69-459"><a href="#cb69-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-460"><a href="#cb69-460" aria-hidden="true" tabindex="-1"></a><span class="in">```{r inlabru_model}</span></span>
<span id="cb69-461"><a href="#cb69-461" aria-hidden="true" tabindex="-1"></a>suelos_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(suelos, </span>
<span id="cb69-462"><a href="#cb69-462" aria-hidden="true" tabindex="-1"></a>                      <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"X"</span>, <span class="st">"Y"</span>), </span>
<span id="cb69-463"><a href="#cb69-463" aria-hidden="true" tabindex="-1"></a>                      <span class="at">crs =</span> <span class="dv">32720</span>)</span>
<span id="cb69-464"><a href="#cb69-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-465"><a href="#cb69-465" aria-hidden="true" tabindex="-1"></a>ajuste_INLAspde <span class="ot">&lt;-</span></span>
<span id="cb69-466"><a href="#cb69-466" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bru</span>(</span>
<span id="cb69-467"><a href="#cb69-467" aria-hidden="true" tabindex="-1"></a>    COS <span class="sc">~</span> </span>
<span id="cb69-468"><a href="#cb69-468" aria-hidden="true" tabindex="-1"></a>      <span class="fu">Intercept</span>(<span class="dv">1</span>) <span class="sc">+</span> elevacion <span class="sc">+</span> twi <span class="sc">+</span> </span>
<span id="cb69-469"><a href="#cb69-469" aria-hidden="true" tabindex="-1"></a>      arcilla <span class="sc">+</span> pH <span class="sc">+</span> </span>
<span id="cb69-470"><a href="#cb69-470" aria-hidden="true" tabindex="-1"></a>      <span class="fu">site</span>(<span class="at">main =</span> coordinates, <span class="at">model =</span> spde),</span>
<span id="cb69-471"><a href="#cb69-471" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">"gaussian"</span>,</span>
<span id="cb69-472"><a href="#cb69-472" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">as_Spatial</span>(suelos_sf)</span>
<span id="cb69-473"><a href="#cb69-473" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb69-474"><a href="#cb69-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-475"><a href="#cb69-475" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-476"><a href="#cb69-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-477"><a href="#cb69-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-478"><a href="#cb69-478" aria-hidden="true" tabindex="-1"></a>En el caso de utilizar la función <span class="in">`inla()`</span>, es necesario especificar los sitios donde se encuentras las observaciones, para esto se generará el objeto <span class="in">`site`</span> a partir de los sitios de la <span class="in">`malla`</span>.</span>
<span id="cb69-479"><a href="#cb69-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-480"><a href="#cb69-480" aria-hidden="true" tabindex="-1"></a><span class="in">```{r inla_model, eval=FALSE}</span></span>
<span id="cb69-481"><a href="#cb69-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-482"><a href="#cb69-482" aria-hidden="true" tabindex="-1"></a>site <span class="ot">&lt;-</span> malla<span class="sc">$</span>idx<span class="sc">$</span>loc</span>
<span id="cb69-483"><a href="#cb69-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-484"><a href="#cb69-484" aria-hidden="true" tabindex="-1"></a>ajuste_INLAspde_inla <span class="ot">&lt;-</span> <span class="fu">inla</span>(</span>
<span id="cb69-485"><a href="#cb69-485" aria-hidden="true" tabindex="-1"></a>  COS <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> elevacion <span class="sc">+</span> twi <span class="sc">+</span> arcilla <span class="sc">+</span> pH <span class="sc">+</span></span>
<span id="cb69-486"><a href="#cb69-486" aria-hidden="true" tabindex="-1"></a>    <span class="fu">f</span>(site, <span class="at">model =</span> spde),</span>
<span id="cb69-487"><a href="#cb69-487" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="st">'gaussian'</span>,</span>
<span id="cb69-488"><a href="#cb69-488" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> suelos,</span>
<span id="cb69-489"><a href="#cb69-489" aria-hidden="true" tabindex="-1"></a>  <span class="at">control.compute =</span> <span class="fu">list</span>(<span class="at">dic =</span> <span class="cn">TRUE</span>),</span>
<span id="cb69-490"><a href="#cb69-490" aria-hidden="true" tabindex="-1"></a>  <span class="at">control.predictor =</span> <span class="fu">list</span>(<span class="at">compute =</span> <span class="cn">TRUE</span>))</span>
<span id="cb69-491"><a href="#cb69-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-492"><a href="#cb69-492" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-493"><a href="#cb69-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-494"><a href="#cb69-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-495"><a href="#cb69-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-498"><a href="#cb69-498" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-499"><a href="#cb69-499" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ajuste_INLAspde)</span>
<span id="cb69-500"><a href="#cb69-500" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-501"><a href="#cb69-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-502"><a href="#cb69-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-503"><a href="#cb69-503" aria-hidden="true" tabindex="-1"></a>El objeto resultante provee información sobre los intervalos de credibilidad del 95\% de los coeficientes de regresión y de los hiperparámetros. Estos son además de la precisión <span class="in">`Theta1`</span> y <span class="in">`Theta2`</span> que definen la función de correlación espacial subyacente. Los parámetros <span class="in">`Theta1`</span> y <span class="in">`Theta2`</span> no son de interpretación directa, pero dependen de los parámetros que caracterizan el proceso espacial (rango y varianza estructural). Utilizando la función <span class="in">`inla.spde2.result()`</span> se puede obtener la distribución a posteriori de los parámetros expresadas en términos de rango y varianza estructural.</span>
<span id="cb69-504"><a href="#cb69-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-505"><a href="#cb69-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-506"><a href="#cb69-506" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r, echo=FALSE, purl=FALSE} --&gt;</span></span>
<span id="cb69-507"><a href="#cb69-507" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- options(OutDec = ".") --&gt;</span></span>
<span id="cb69-508"><a href="#cb69-508" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb69-509"><a href="#cb69-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-510"><a href="#cb69-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-511"><a href="#cb69-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-512"><a href="#cb69-512" aria-hidden="true" tabindex="-1"></a><span class="in">```{r thetas}</span></span>
<span id="cb69-513"><a href="#cb69-513" aria-hidden="true" tabindex="-1"></a>resultados_spde <span class="ot">&lt;-</span></span>
<span id="cb69-514"><a href="#cb69-514" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inla.spde2.result</span>(<span class="at">inla =</span> ajuste_INLAspde,</span>
<span id="cb69-515"><a href="#cb69-515" aria-hidden="true" tabindex="-1"></a>                    <span class="at">name =</span> <span class="st">"site"</span>, <span class="at">spde =</span> spde)</span>
<span id="cb69-516"><a href="#cb69-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-517"><a href="#cb69-517" aria-hidden="true" tabindex="-1"></a><span class="fu">inla.emarginal</span>(<span class="cf">function</span>(x) {x},</span>
<span id="cb69-518"><a href="#cb69-518" aria-hidden="true" tabindex="-1"></a>  resultados_spde<span class="sc">$</span>marginals.range.nominal[[<span class="dv">1</span>]])</span>
<span id="cb69-519"><a href="#cb69-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-520"><a href="#cb69-520" aria-hidden="true" tabindex="-1"></a><span class="fu">inla.emarginal</span>(<span class="cf">function</span>(x) {x},</span>
<span id="cb69-521"><a href="#cb69-521" aria-hidden="true" tabindex="-1"></a>  resultados_spde<span class="sc">$</span>marginals.variance.nominal[[<span class="dv">1</span>]])</span>
<span id="cb69-522"><a href="#cb69-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-523"><a href="#cb69-523" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-524"><a href="#cb69-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-525"><a href="#cb69-525" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r, echo=FALSE, purl=FALSE} --&gt;</span></span>
<span id="cb69-526"><a href="#cb69-526" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- options(OutDec = ",") --&gt;</span></span>
<span id="cb69-527"><a href="#cb69-527" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb69-528"><a href="#cb69-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-529"><a href="#cb69-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-530"><a href="#cb69-530" aria-hidden="true" tabindex="-1"></a>Para comparar los modelos de regresión ajustados con errores independientes y con correlación espacial se visualizan medidas de bondad de ajuste como DIC para ambos modelos.</span>
<span id="cb69-531"><a href="#cb69-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-534"><a href="#cb69-534" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-535"><a href="#cb69-535" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(ajuste_INLA<span class="sc">$</span>dic<span class="sc">$</span>dic, ajuste_INLAspde<span class="sc">$</span>dic<span class="sc">$</span>dic)</span>
<span id="cb69-536"><a href="#cb69-536" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-537"><a href="#cb69-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-538"><a href="#cb69-538" aria-hidden="true" tabindex="-1"></a>Comparando los valores de DIC se observa la conveniencia de usar un modelo con correlación espacial respecto a uno que supone los valores de COS independientes, dado que el primero tiene un valor menor.</span>
<span id="cb69-539"><a href="#cb69-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-540"><a href="#cb69-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-541"><a href="#cb69-541" aria-hidden="true" tabindex="-1"></a><span class="fu">### Obtención de predicciones</span></span>
<span id="cb69-542"><a href="#cb69-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-543"><a href="#cb69-543" aria-hidden="true" tabindex="-1"></a>Para obtener predicciones se puede utilizar tanto funciones del paquete <span class="in">`inlabru`</span> o bien específicas del paquete <span class="in">`INLA`</span>. Aquí, a modo ilustrativo, se presentan ambas formas de obtener los mismos predichos, aunque el usuario deberá optar por la de su conveniencia. Para ambas alternativas es necesario contar con un objeto que contenga los sitios en los que queremos realizar las predicciones. En el caso de no utilizar funciones de <span class="in">`inlabru`</span> es necesario que este objeto contenga tanto información de los sitios a predecir como los datos de los sitios observados. La función <span class="in">`bind_rows()`</span> del paquete <span class="in">`dplyr`</span> permite juntar dos objetos de clase <span class="in">`data.frame`</span> que contengan el mismo nombre de columnas colocando <span class="in">`NA`</span> cuando no hay valor para un campo.</span>
<span id="cb69-544"><a href="#cb69-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-547"><a href="#cb69-547" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-548"><a href="#cb69-548" aria-hidden="true" tabindex="-1"></a>suelos_pred_INLA <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(suelos_pred,</span>
<span id="cb69-549"><a href="#cb69-549" aria-hidden="true" tabindex="-1"></a>                                     suelos)</span>
<span id="cb69-550"><a href="#cb69-550" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(suelos_pred_INLA)</span>
<span id="cb69-551"><a href="#cb69-551" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-552"><a href="#cb69-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-553"><a href="#cb69-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-554"><a href="#cb69-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-555"><a href="#cb69-555" aria-hidden="true" tabindex="-1"></a><span class="fu">## Predicciones utilizando el paquete `inlabru`</span></span>
<span id="cb69-556"><a href="#cb69-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-557"><a href="#cb69-557" aria-hidden="true" tabindex="-1"></a>El paquete <span class="in">`inlabru`</span> contiene una función <span class="in">`predict`</span> la cual puede ser utilizada para obtener las predicciones. Transformaremos el objeto <span class="in">`suelos_pred_INLA`</span> en uno de clase espacial. Para utilizar esta función, el modelo debe ajustarse mediante la función <span class="in">`bru()`</span>. Mediante una fórmula, es necesario especificar los efectos que queremos considerar para la predicción, en este caso consideraremos todos los efectos del ajuste. </span>
<span id="cb69-558"><a href="#cb69-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-561"><a href="#cb69-561" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-562"><a href="#cb69-562" aria-hidden="true" tabindex="-1"></a>suelos_pred_INLA_sf <span class="ot">&lt;-</span></span>
<span id="cb69-563"><a href="#cb69-563" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(suelos_pred_INLA, </span>
<span id="cb69-564"><a href="#cb69-564" aria-hidden="true" tabindex="-1"></a>           <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"X"</span>, <span class="st">"Y"</span>), </span>
<span id="cb69-565"><a href="#cb69-565" aria-hidden="true" tabindex="-1"></a>           <span class="at">crs =</span> <span class="dv">32720</span>)</span>
<span id="cb69-566"><a href="#cb69-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-567"><a href="#cb69-567" aria-hidden="true" tabindex="-1"></a>pred_INLAspde_bru <span class="ot">&lt;-</span></span>
<span id="cb69-568"><a href="#cb69-568" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(</span>
<span id="cb69-569"><a href="#cb69-569" aria-hidden="true" tabindex="-1"></a>    ajuste_INLAspde,</span>
<span id="cb69-570"><a href="#cb69-570" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_Spatial</span>(suelos_pred_INLA_sf),</span>
<span id="cb69-571"><a href="#cb69-571" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span> Intercept <span class="sc">+</span> elevacion <span class="sc">+</span> </span>
<span id="cb69-572"><a href="#cb69-572" aria-hidden="true" tabindex="-1"></a>      twi <span class="sc">+</span> arcilla <span class="sc">+</span> pH <span class="sc">+</span> site</span>
<span id="cb69-573"><a href="#cb69-573" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb69-574"><a href="#cb69-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-575"><a href="#cb69-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-576"><a href="#cb69-576" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-577"><a href="#cb69-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-578"><a href="#cb69-578" aria-hidden="true" tabindex="-1"></a>Los predichos pueden ser graficados utilizando el paquete <span class="in">`ggplot2`</span> y la función <span class="in">`gg()`</span> del paquete <span class="in">`inlabru.`</span></span>
<span id="cb69-579"><a href="#cb69-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-582"><a href="#cb69-582" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-583"><a href="#cb69-583" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb69-584"><a href="#cb69-584" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gg</span>(pred_INLAspde_bru, <span class="fu">aes</span>(<span class="at">color =</span> mean), <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb69-585"><a href="#cb69-585" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb69-586"><a href="#cb69-586" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"X"</span>,</span>
<span id="cb69-587"><a href="#cb69-587" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Y"</span>,</span>
<span id="cb69-588"><a href="#cb69-588" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"COS predicho"</span>)</span>
<span id="cb69-589"><a href="#cb69-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-590"><a href="#cb69-590" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-591"><a href="#cb69-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-592"><a href="#cb69-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-593"><a href="#cb69-593" aria-hidden="true" tabindex="-1"></a><span class="fu">## Utilizando `INLA`</span></span>
<span id="cb69-594"><a href="#cb69-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-595"><a href="#cb69-595" aria-hidden="true" tabindex="-1"></a>En R-INLA no existe una funcion <span class="in">`predict()`</span> como en gls. Las predicciones deben ser obtenidas como parte del modelo ajustado. Dado que las predicciones puedes ser entendidas como el ajuste de un modelo con datos faltantes simplemente se especificará, antes del ajuste, <span class="in">`y[i] = NA`</span> para aquellos sitios donde se desea predecir. Las distribuciones de los valores predichos no son devueltas directamente, pero se pueden explorar. <span class="in">`INLA`</span> retorna las a posteriori marginales para los efectos aleatorios y para el predictor linear en el sitio faltante. Adicionando el ruido de las observaciones a los valores ajustados se obtienen los valores predichos para el sitio. </span>
<span id="cb69-596"><a href="#cb69-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-597"><a href="#cb69-597" aria-hidden="true" tabindex="-1"></a>Luego de identificar el predictor lineal, debe definirse la malla y el modelo espacial para la grilla de predicción asociada a los efectos aleatorios de sitios. Mediante el argumento <span class="in">`control.predictor`</span> en la función <span class="in">`inla()`</span> se indica que debe computarse el valor de la variable respuesta en el lugar del dato faltante.</span>
<span id="cb69-598"><a href="#cb69-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-601"><a href="#cb69-601" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-602"><a href="#cb69-602" aria-hidden="true" tabindex="-1"></a>sitios_pred <span class="ot">&lt;-</span> suelos_pred_INLA[, <span class="fu">c</span>(<span class="st">"X"</span>, <span class="st">"Y"</span>)]</span>
<span id="cb69-603"><a href="#cb69-603" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-604"><a href="#cb69-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-605"><a href="#cb69-605" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = TRUE}</span></span>
<span id="cb69-606"><a href="#cb69-606" aria-hidden="true" tabindex="-1"></a>malla_pred <span class="ot">&lt;-</span> <span class="fu">inla.mesh.2d</span>(<span class="at">loc =</span> sitios_pred, </span>
<span id="cb69-607"><a href="#cb69-607" aria-hidden="true" tabindex="-1"></a>                           <span class="at">cutoff =</span> <span class="dv">200</span>,</span>
<span id="cb69-608"><a href="#cb69-608" aria-hidden="true" tabindex="-1"></a>                           <span class="at">max.edge =</span> <span class="dv">200000</span>)</span>
<span id="cb69-609"><a href="#cb69-609" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-610"><a href="#cb69-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-611"><a href="#cb69-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-612"><a href="#cb69-612" aria-hidden="true" tabindex="-1"></a><span class="in">```{r inlapredict}</span></span>
<span id="cb69-613"><a href="#cb69-613" aria-hidden="true" tabindex="-1"></a>nodos_pred <span class="ot">&lt;-</span> malla_pred<span class="sc">$</span>idx<span class="sc">$</span>loc</span>
<span id="cb69-614"><a href="#cb69-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-615"><a href="#cb69-615" aria-hidden="true" tabindex="-1"></a>spde_pred <span class="ot">&lt;-</span> <span class="fu">inla.spde2.pcmatern</span>(</span>
<span id="cb69-616"><a href="#cb69-616" aria-hidden="true" tabindex="-1"></a>  <span class="at">mesh =</span> malla_pred,</span>
<span id="cb69-617"><a href="#cb69-617" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior.range =</span> <span class="fu">c</span>(<span class="dv">20000</span>, <span class="fl">0.05</span>),</span>
<span id="cb69-618"><a href="#cb69-618" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior.sigma =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.05</span>)</span>
<span id="cb69-619"><a href="#cb69-619" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-620"><a href="#cb69-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-621"><a href="#cb69-621" aria-hidden="true" tabindex="-1"></a>pred_INLAspde <span class="ot">&lt;-</span></span>
<span id="cb69-622"><a href="#cb69-622" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inla</span>(</span>
<span id="cb69-623"><a href="#cb69-623" aria-hidden="true" tabindex="-1"></a>    COS <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> elevacion <span class="sc">+</span> twi <span class="sc">+</span> </span>
<span id="cb69-624"><a href="#cb69-624" aria-hidden="true" tabindex="-1"></a>      arcilla <span class="sc">+</span> pH <span class="sc">+</span> </span>
<span id="cb69-625"><a href="#cb69-625" aria-hidden="true" tabindex="-1"></a>      <span class="fu">f</span>(nodos_pred, </span>
<span id="cb69-626"><a href="#cb69-626" aria-hidden="true" tabindex="-1"></a>        <span class="at">model =</span> spde_pred, </span>
<span id="cb69-627"><a href="#cb69-627" aria-hidden="true" tabindex="-1"></a>        <span class="at">diagonal =</span> <span class="fl">1e-6</span>),</span>
<span id="cb69-628"><a href="#cb69-628" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">'gaussian'</span>,</span>
<span id="cb69-629"><a href="#cb69-629" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> suelos_pred_INLA,</span>
<span id="cb69-630"><a href="#cb69-630" aria-hidden="true" tabindex="-1"></a>    <span class="at">control.predictor =</span> </span>
<span id="cb69-631"><a href="#cb69-631" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(<span class="at">link =</span> <span class="dv">1</span>, <span class="at">compute =</span> <span class="cn">TRUE</span>)</span>
<span id="cb69-632"><a href="#cb69-632" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb69-633"><a href="#cb69-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-634"><a href="#cb69-634" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-635"><a href="#cb69-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-636"><a href="#cb69-636" aria-hidden="true" tabindex="-1"></a>Se puede obtener la media de la distribución a posteriori de los valores predichos para cada sitio en la grilla de predicción, para mapear la distribución espacial de la variable respuesta.</span>
<span id="cb69-637"><a href="#cb69-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-638"><a href="#cb69-638" aria-hidden="true" tabindex="-1"></a><span class="in">```{r unionpredichosinla}</span></span>
<span id="cb69-639"><a href="#cb69-639" aria-hidden="true" tabindex="-1"></a>COS_pred_INLA <span class="ot">&lt;-</span></span>
<span id="cb69-640"><a href="#cb69-640" aria-hidden="true" tabindex="-1"></a>  pred_INLAspde<span class="sc">$</span>summary.fitted.values<span class="sc">$</span>mean</span>
<span id="cb69-641"><a href="#cb69-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-642"><a href="#cb69-642" aria-hidden="true" tabindex="-1"></a>COS_pred_inlabru <span class="ot">&lt;-</span></span>
<span id="cb69-643"><a href="#cb69-643" aria-hidden="true" tabindex="-1"></a>  pred_INLAspde_bru<span class="sc">$</span>mean</span>
<span id="cb69-644"><a href="#cb69-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-645"><a href="#cb69-645" aria-hidden="true" tabindex="-1"></a>pred_err_corr <span class="ot">&lt;-</span></span>
<span id="cb69-646"><a href="#cb69-646" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(</span>
<span id="cb69-647"><a href="#cb69-647" aria-hidden="true" tabindex="-1"></a>    suelos_pred_INLA_sf,</span>
<span id="cb69-648"><a href="#cb69-648" aria-hidden="true" tabindex="-1"></a>    <span class="st">"COS_pred_INLA"</span> <span class="ot">=</span> COS_pred_INLA,</span>
<span id="cb69-649"><a href="#cb69-649" aria-hidden="true" tabindex="-1"></a>    <span class="st">"COS_pred_inlabru"</span> <span class="ot">=</span> COS_pred_inlabru</span>
<span id="cb69-650"><a href="#cb69-650" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb69-651"><a href="#cb69-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-652"><a href="#cb69-652" aria-hidden="true" tabindex="-1"></a>map_pred_inla <span class="ot">&lt;-</span> </span>
<span id="cb69-653"><a href="#cb69-653" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(pred_err_corr) <span class="sc">+</span></span>
<span id="cb69-654"><a href="#cb69-654" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_dots</span>(<span class="st">"COS_pred_INLA"</span>, <span class="at">style =</span> <span class="st">"cont"</span>) </span>
<span id="cb69-655"><a href="#cb69-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-656"><a href="#cb69-656" aria-hidden="true" tabindex="-1"></a>map_pred_inlabru <span class="ot">&lt;-</span>  </span>
<span id="cb69-657"><a href="#cb69-657" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(pred_err_corr) <span class="sc">+</span></span>
<span id="cb69-658"><a href="#cb69-658" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_dots</span>(<span class="st">"COS_pred_inlabru"</span>, <span class="at">style =</span> <span class="st">"cont"</span>)</span>
<span id="cb69-659"><a href="#cb69-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-660"><a href="#cb69-660" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_arrange</span>(map_pred_inla, </span>
<span id="cb69-661"><a href="#cb69-661" aria-hidden="true" tabindex="-1"></a>             map_pred_inlabru)</span>
<span id="cb69-662"><a href="#cb69-662" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-663"><a href="#cb69-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-664"><a href="#cb69-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-665"><a href="#cb69-665" aria-hidden="true" tabindex="-1"></a><span class="fu">## Regresión vía modelos basados en árbol</span></span>
<span id="cb69-666"><a href="#cb69-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-667"><a href="#cb69-667" aria-hidden="true" tabindex="-1"></a>Se ajusta un modelo GBR o *gradient boosting model* con errores correlacionados espacialmente en dos pasos, primero se optimiza la parametrización del predictor GBR usando datos de los sitios observados y se obtienen los residuos de este modelo. En segunda instancia, se ajusta un modelo de semivariaograma a los residuos que se usará para realizar predicción kriging de residuos sobre toda la grilla de predicción. Finalmente, los residuos predichos se adicional a la componente sistemática predicha con el modelo GBR sobre la misma grilla de predicción.</span>
<span id="cb69-668"><a href="#cb69-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-669"><a href="#cb69-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-670"><a href="#cb69-670" aria-hidden="true" tabindex="-1"></a>Para implementar GBR se utiliza el paquete <span class="in">`caret`</span>. Para optimizar el modelo GBM. se genera una grilla de valores posibles para sus parámetros con la función <span class="in">`expand.grid()`</span>. Esta función genera un <span class="in">`data.frame`</span> que contiene en las filas cada una de las combinaciones posibles generadas a partir de los rangos de valores propuestos para cada parámetro del modelo GBM. Éstos son: <span class="in">`n.trees`</span> que definen el número total de árboles ajustados, <span class="in">`shrinkage`</span> que regula la extensión de cada árbol, <span class="in">`n.minobsinnode`</span> que representa el mínimo de observaciones en cada nodo terminal y <span class="in">`bag.fraction`</span> la proporción de observaciones del grupo de entrenamiento seleccionadas aleatoriamente para la expansión sucesiva del árbol. El tipo de validación cruzada para la optimización de los parámetros del modelo se realiza a través de la función <span class="in">`train.control`</span>. Luego utilizando la función <span class="in">`train()`</span> se especifica el modelo con el argumento <span class="in">`method`</span>, en este caso <span class="in">`gbm.`</span> La misma función <span class="in">`train()`</span> genera un objeto con el modelo parametrizado con la configuración valores que arrojan el menor error predictivo, es decir con un modelo  del tipo árbol optimizado.</span>
<span id="cb69-671"><a href="#cb69-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-672"><a href="#cb69-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-673"><a href="#cb69-673" aria-hidden="true" tabindex="-1"></a><span class="in">```{r traingbm}</span></span>
<span id="cb69-674"><a href="#cb69-674" aria-hidden="true" tabindex="-1"></a>param_gbm <span class="ot">&lt;-</span>  <span class="fu">expand.grid</span>(</span>
<span id="cb69-675"><a href="#cb69-675" aria-hidden="true" tabindex="-1"></a>  <span class="at">interaction.depth =</span> <span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>),</span>
<span id="cb69-676"><a href="#cb69-676" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.trees =</span> (<span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb69-677"><a href="#cb69-677" aria-hidden="true" tabindex="-1"></a>  <span class="at">shrinkage =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.01</span>),</span>
<span id="cb69-678"><a href="#cb69-678" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.minobsinnode =</span> <span class="fu">c</span>(<span class="dv">7</span>, <span class="dv">5</span>)</span>
<span id="cb69-679"><a href="#cb69-679" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-680"><a href="#cb69-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-681"><a href="#cb69-681" aria-hidden="true" tabindex="-1"></a>control <span class="ot">&lt;-</span> <span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">"repeatedcv"</span>,</span>
<span id="cb69-682"><a href="#cb69-682" aria-hidden="true" tabindex="-1"></a>                        <span class="at">number =</span> <span class="dv">5</span>,</span>
<span id="cb69-683"><a href="#cb69-683" aria-hidden="true" tabindex="-1"></a>                        <span class="at">repeats =</span> <span class="dv">5</span>)</span>
<span id="cb69-684"><a href="#cb69-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-685"><a href="#cb69-685" aria-hidden="true" tabindex="-1"></a>ajuste_gbm <span class="ot">&lt;-</span> <span class="fu">train</span>(</span>
<span id="cb69-686"><a href="#cb69-686" aria-hidden="true" tabindex="-1"></a>  COS <span class="sc">~</span> elevacion <span class="sc">+</span> twi <span class="sc">+</span> arcilla <span class="sc">+</span> pH,</span>
<span id="cb69-687"><a href="#cb69-687" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> suelos,</span>
<span id="cb69-688"><a href="#cb69-688" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"gbm"</span>,</span>
<span id="cb69-689"><a href="#cb69-689" aria-hidden="true" tabindex="-1"></a>  <span class="at">trControl =</span> control,</span>
<span id="cb69-690"><a href="#cb69-690" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span>,</span>
<span id="cb69-691"><a href="#cb69-691" aria-hidden="true" tabindex="-1"></a>  <span class="at">metric =</span> <span class="st">"RMSE"</span>,</span>
<span id="cb69-692"><a href="#cb69-692" aria-hidden="true" tabindex="-1"></a>  <span class="at">tuneGrid =</span> param_gbm</span>
<span id="cb69-693"><a href="#cb69-693" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-694"><a href="#cb69-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-695"><a href="#cb69-695" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-696"><a href="#cb69-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-697"><a href="#cb69-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-698"><a href="#cb69-698" aria-hidden="true" tabindex="-1"></a>Pidiendo un gráfico del objeto <span class="in">`ajuste_gbm`</span> se puede acceder al resumen del proceso de optimización de los parámetros. El rendimiento del modelo depende de estos parámetros, pero es posible identificar las combinaciones que generan el mejor desempeño predictivo. A su vez, a través del comando <span class="in">`ajuste_gbm$bestTune`</span> podemos acceder a los parámetros que definen el modelo óptimo.</span>
<span id="cb69-699"><a href="#cb69-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-700"><a href="#cb69-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-701"><a href="#cb69-701" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, mejorajustegbm_plot}</span></span>
<span id="cb69-702"><a href="#cb69-702" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(ajuste_gbm) <span class="sc">+</span> </span>
<span id="cb69-703"><a href="#cb69-703" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb69-704"><a href="#cb69-704" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-705"><a href="#cb69-705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-706"><a href="#cb69-706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-707"><a href="#cb69-707" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, mejorajustegbm_table}</span></span>
<span id="cb69-708"><a href="#cb69-708" aria-hidden="true" tabindex="-1"></a>ajuste_gbm<span class="sc">$</span>bestTune</span>
<span id="cb69-709"><a href="#cb69-709" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-710"><a href="#cb69-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-711"><a href="#cb69-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-712"><a href="#cb69-712" aria-hidden="true" tabindex="-1"></a>El objeto resultante del ajuste GBM, provee un gráfico de la influencia relativa de cada variable predictora para explicar COS, y el árbol con el que se realizará la predicción. A partir de la función <span class="in">`predict()`</span> sobre los datos observados, se obtienen predichos y consecuentemente los residuos del modelo GBR.</span>
<span id="cb69-713"><a href="#cb69-713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-714"><a href="#cb69-714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-715"><a href="#cb69-715" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, resumenajustegbm}</span></span>
<span id="cb69-716"><a href="#cb69-716" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ajuste_gbm)</span>
<span id="cb69-717"><a href="#cb69-717" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-718"><a href="#cb69-718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-719"><a href="#cb69-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-720"><a href="#cb69-720" aria-hidden="true" tabindex="-1"></a>En la segunda etapa, se ajusta una función de semivarianza a los residuos del modelo GBM utilizando las funciones <span class="in">`variogram`</span> y <span class="in">`fit.variogram`</span> del paquete <span class="in">`gstat`</span>.</span>
<span id="cb69-721"><a href="#cb69-721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-722"><a href="#cb69-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-723"><a href="#cb69-723" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=TRUE, message=FALSE}</span></span>
<span id="cb69-724"><a href="#cb69-724" aria-hidden="true" tabindex="-1"></a>suelos<span class="sc">$</span>residuosgbm <span class="ot">&lt;-</span></span>
<span id="cb69-725"><a href="#cb69-725" aria-hidden="true" tabindex="-1"></a>  suelos<span class="sc">$</span>COS <span class="sc">-</span> <span class="fu">predict</span>(ajuste_gbm, </span>
<span id="cb69-726"><a href="#cb69-726" aria-hidden="true" tabindex="-1"></a>                       <span class="at">newdata =</span> suelos)</span>
<span id="cb69-727"><a href="#cb69-727" aria-hidden="true" tabindex="-1"></a>suelos <span class="ot">&lt;-</span> </span>
<span id="cb69-728"><a href="#cb69-728" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(suelos, </span>
<span id="cb69-729"><a href="#cb69-729" aria-hidden="true" tabindex="-1"></a>           <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"X"</span>, <span class="st">"Y"</span>), </span>
<span id="cb69-730"><a href="#cb69-730" aria-hidden="true" tabindex="-1"></a>           <span class="at">crs =</span> <span class="dv">32720</span>)</span>
<span id="cb69-731"><a href="#cb69-731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-732"><a href="#cb69-732" aria-hidden="true" tabindex="-1"></a>semiv_gbmk <span class="ot">&lt;-</span> <span class="fu">variogram</span>(residuosgbm <span class="sc">~</span> <span class="dv">1</span>, suelos)</span>
<span id="cb69-733"><a href="#cb69-733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-734"><a href="#cb69-734" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(semiv_gbmk)</span>
<span id="cb69-735"><a href="#cb69-735" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-736"><a href="#cb69-736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-737"><a href="#cb69-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-738"><a href="#cb69-738" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=TRUE, message=FALSE}</span></span>
<span id="cb69-739"><a href="#cb69-739" aria-hidden="true" tabindex="-1"></a>semiv_aj_gbmk <span class="ot">&lt;-</span></span>
<span id="cb69-740"><a href="#cb69-740" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit.variogram</span>(semiv_gbmk ,</span>
<span id="cb69-741"><a href="#cb69-741" aria-hidden="true" tabindex="-1"></a>                <span class="fu">vgm</span>(<span class="fu">c</span>(<span class="st">"Exp"</span>, <span class="st">"Sph"</span>, <span class="st">"Gau"</span>)))</span>
<span id="cb69-742"><a href="#cb69-742" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(semiv_gbmk, semiv_aj_gbmk)</span>
<span id="cb69-743"><a href="#cb69-743" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-744"><a href="#cb69-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-745"><a href="#cb69-745" aria-hidden="true" tabindex="-1"></a>Para obtener un predicción de COS en los sitios no muestreados, se realiza la predicción kriging de los residuos sobre los sitios de la grilla de predicción utilizando el modelo ajustado en el paso anterior a partir de la función <span class="in">`krige()`</span>. Luego se utiliza el modelo GBM (árbol optimo) para predecir COS sobre la grilla de predicción sin considerar la espacialidad. Finalmente, la predicción de COS en cada sitio se compone sumando la predicción del modelo GBM y la predicción kriging de los residuos para cada sitio de la grilla de predicción.</span>
<span id="cb69-746"><a href="#cb69-746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-747"><a href="#cb69-747" aria-hidden="true" tabindex="-1"></a><span class="in">```{r predichosgbm, echo=TRUE, message=FALSE}</span></span>
<span id="cb69-748"><a href="#cb69-748" aria-hidden="true" tabindex="-1"></a>krig_res_gbm <span class="ot">&lt;-</span></span>
<span id="cb69-749"><a href="#cb69-749" aria-hidden="true" tabindex="-1"></a>  <span class="fu">krige</span>(</span>
<span id="cb69-750"><a href="#cb69-750" aria-hidden="true" tabindex="-1"></a>    residuosgbm <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb69-751"><a href="#cb69-751" aria-hidden="true" tabindex="-1"></a>    <span class="at">location =</span> suelos,</span>
<span id="cb69-752"><a href="#cb69-752" aria-hidden="true" tabindex="-1"></a>    <span class="at">newdata =</span> pred_err_corr,</span>
<span id="cb69-753"><a href="#cb69-753" aria-hidden="true" tabindex="-1"></a>    <span class="at">model =</span> semiv_aj_gbmk</span>
<span id="cb69-754"><a href="#cb69-754" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb69-755"><a href="#cb69-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-756"><a href="#cb69-756" aria-hidden="true" tabindex="-1"></a>gbmk_pred <span class="ot">&lt;-</span></span>
<span id="cb69-757"><a href="#cb69-757" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(ajuste_gbm,</span>
<span id="cb69-758"><a href="#cb69-758" aria-hidden="true" tabindex="-1"></a>          <span class="at">newdata =</span> pred_err_corr, </span>
<span id="cb69-759"><a href="#cb69-759" aria-hidden="true" tabindex="-1"></a>          <span class="at">na.action =</span> na.pass) <span class="sc">+</span></span>
<span id="cb69-760"><a href="#cb69-760" aria-hidden="true" tabindex="-1"></a>  krig_res_gbm<span class="sc">$</span>var1.pred</span>
<span id="cb69-761"><a href="#cb69-761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-762"><a href="#cb69-762" aria-hidden="true" tabindex="-1"></a>pred_err_corr <span class="ot">&lt;-</span> </span>
<span id="cb69-763"><a href="#cb69-763" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(pred_err_corr,</span>
<span id="cb69-764"><a href="#cb69-764" aria-hidden="true" tabindex="-1"></a>        <span class="st">"COS_pred_GBM"</span> <span class="ot">=</span> gbmk_pred)</span>
<span id="cb69-765"><a href="#cb69-765" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-766"><a href="#cb69-766" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(pred_err_corr) <span class="sc">+</span></span>
<span id="cb69-767"><a href="#cb69-767" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_dots</span>(<span class="st">"COS_pred_GBM"</span>, <span class="at">style =</span> <span class="st">"cont"</span>) <span class="sc">+</span></span>
<span id="cb69-768"><a href="#cb69-768" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">legend.outside =</span> <span class="cn">TRUE</span>)</span>
<span id="cb69-769"><a href="#cb69-769" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-770"><a href="#cb69-770" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-771"><a href="#cb69-771" aria-hidden="true" tabindex="-1"></a></span>
</code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">Guía para el análisis de datos espaciales. Aplicaciones en agricultura</div>   
    <div class="nav-footer-right">Este libro se construyo con <a href="https://quarto.org/">Quarto</a>.</div>
  </div>
</footer>


<script src="site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>